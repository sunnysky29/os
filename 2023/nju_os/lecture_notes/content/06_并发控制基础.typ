#import "../template.typ": *
#pagebreak()
= å¹¶å‘æ§åˆ¶åŸºç¡€

== äº’æ–¥é—®é¢˜

=== å¹¶å‘ç¼–ç¨‹ï¼šä»å…¥é—¨åˆ°æ”¾å¼ƒ

äººç±»æ˜¯ sequential creature

- ç¼–è¯‘ä¼˜åŒ– + weak memory model å¯¼è‡´éš¾ä»¥ç†è§£çš„å¹¶å‘æ‰§è¡Œ
- æœ‰å¤šéš¾ç†è§£å‘¢ï¼Ÿ
  - [ Verifying sequential consistency æ˜¯ NP-å®Œå…¨é—®é¢˜
    ](https://epubs.siam.org/doi/10.1137/S0097539794279614)

äººç±»æ˜¯ (ä¸è½»è¨€æ”¾å¼ƒçš„) sequential creature

- æœ‰é—®é¢˜ï¼Œå°±ä¼šè¯•ç€å»è§£å†³
- æ‰‹æ®µï¼šâ€œå›é€€åˆ°â€ é¡ºåºæ‰§è¡Œ
  - æ ‡è®°è‹¥å¹²å—ä»£ç ï¼Œä½¿å¾—è¿™äº›ä»£ç ä¸€å®šèƒ½æŒ‰æŸä¸ªé¡ºåºæ‰§è¡Œ
  - ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥å®‰å…¨åœ°åœ¨å—é‡Œè®°å½•æ‰§è¡Œçš„é¡ºåº

=== å›é€€åˆ°é¡ºåºæ‰§è¡Œï¼šäº’æ–¥

æ’å…¥ â€œç¥ç§˜ä»£ç â€ï¼Œä½¿å¾—æ‰€æœ‰å…¶ä»– â€œç¥ç§˜ä»£ç â€ éƒ½ä¸èƒ½å¹¶å‘, ç”± â€œç¥ç§˜ä»£ç â€
é¢†å¯¼ä¸ä¼šå¹¶å‘çš„ä»£ç  (ä¾‹å¦‚ pure functions) æ‰§è¡Œ:

```c
void Tsum() {
  stop_the_world();
  // ä¸´ç•ŒåŒº critical section
  sum++;
  resume_the_world();
}
```

Stop the world çœŸçš„æ˜¯å¯èƒ½çš„

- Java æœ‰ â€œstop the world GCâ€
- å•ä¸ªå¤„ç†å™¨å¯ä»¥å…³é—­ä¸­æ–­
- å¤šä¸ªå¤„ç†å™¨ä¹Ÿå¯ä»¥å‘é€æ ¸é—´ä¸­æ–­

>
å› ä¸ºéœ€è¦å¹¶å‘çš„ä»£ç æ€»æ˜¯å å°‘æ•°çš„ï¼Œä¸éœ€è¦å¹¶å‘çš„ä»£ç å¹¶å‘æ‰§è¡Œå°±å¯ä»¥æé«˜æ€§èƒ½(åŠ é€Ÿæ¯”)ã€‚å¦‚æœå¹¶å‘çš„ä»£ç æ¯”ä¾‹å¤§ï¼Œé‚£åŠ é€Ÿæ¯”å°±ä¼šå°ã€‚

=== å¤±è´¥çš„å°è¯•

```c
int locked = UNLOCK;

void critical_section() {
retry:
  if (locked != UNLOCK) {
    goto retry;
  }
  locked = LOCK;

  // critical section

  locked = UNLOCK;
}
```

å’Œ â€œå±±å¯¨æ”¯ä»˜å®â€ å®Œå…¨ä¸€æ ·çš„é”™è¯¯: å¹¶å‘ç¨‹åºä¸èƒ½ä¿è¯ load + store çš„åŸå­æ€§

=== æ›´ä¸¥è‚ƒåœ°å°è¯•ï¼šç¡®å®šå‡è®¾ã€è®¾è®¡ç®—æ³•

å‡è®¾ï¼šå†…å­˜çš„è¯»/å†™å¯ä»¥ä¿è¯é¡ºåºã€åŸå­å®Œæˆ

- `val = atomic_load(ptr)`
  - çœ‹ä¸€çœ¼æŸä¸ªåœ°æ–¹çš„å­—æ¡ (åªèƒ½çœ‹åˆ°ç¬é—´çš„å­—)
  - åˆšçœ‹å®Œå°±å¯èƒ½è¢«æ”¹æ‰
- `atomic_store(ptr, val)`
  - å¯¹åº”å¾€æŸä¸ªåœ°æ–¹ â€œè´´ä¸€å¼ çº¸æ¡â€ (å¿…é¡»é—­çœ¼ç›²è´´)
  - è´´å®Œä¸€ç¬é—´å°±å¯èƒ½è¢«åˆ«äººè¦†ç›–

å¯¹åº”äº model checker

- æ¯ä¸€è¡Œå¯ä»¥æ‰§è¡Œä¸€æ¬¡å…¨å±€å˜é‡è¯»æˆ–å†™
- æ¯ä¸ªæ“ä½œæ‰§è¡Œä¹‹åéƒ½å‘ç”Ÿ `sys_sched()`

==== æ­£ç¡®æ€§ä¸æ˜çš„å¥‡æ€ªå°è¯• (Peterson ç®—æ³•)

A å’Œ B äº‰ç”¨å•æ‰€çš„åŒ…å¢

- æƒ³è¿›å…¥åŒ…å¢ä¹‹å‰ï¼ŒA/B éƒ½é¦–å…ˆä¸¾èµ·è‡ªå·±çš„æ——å­
  - A å¾€å•æ‰€é—¨ä¸Šè´´ä¸Š â€œB æ­£åœ¨ä½¿ç”¨â€ çš„æ ‡ç­¾
  - B å¾€å•æ‰€é—¨ä¸Šè´´ä¸Š â€œA æ­£åœ¨ä½¿ç”¨â€ çš„æ ‡ç­¾
- ç„¶åï¼Œå¦‚æœå¯¹æ–¹ä¸¾ç€æ——ï¼Œä¸”é—¨ä¸Šçš„åå­—æ˜¯å¯¹æ–¹ï¼Œç­‰å¾…
  - å¦åˆ™å¯ä»¥è¿›å…¥åŒ…å¢
- å‡ºåŒ…å¢åï¼Œæ”¾ä¸‹è‡ªå·±çš„æ——å­ (å®Œå…¨ä¸ç®¡é—¨ä¸Šçš„æ ‡ç­¾)

===== ä¹ é¢˜ï¼šè¯æ˜ Peterson ç®—æ³•æ­£ç¡®ï¼Œæˆ–ç»™å‡ºåä¾‹

è¿›å…¥ä¸´ç•ŒåŒºçš„æƒ…å†µ

- å¦‚æœåªæœ‰ä¸€ä¸ªäººä¸¾æ——ï¼Œä»–å°±å¯ä»¥ç›´æ¥è¿›å…¥
- å¦‚æœä¸¤ä¸ªäººåŒæ—¶ä¸¾æ——ï¼Œç”±å•æ‰€é—¨ä¸Šçš„æ ‡ç­¾å†³å®šè°è¿›
  - æ‰‹å¿« ğŸˆ¶ï¸ (è¢«å¦ä¸€ä¸ªäººçš„æ ‡ç­¾è¦†ç›–)ã€æ‰‹æ…¢ ğŸˆš

ä¸€äº›å…·ä½“çš„ç»†èŠ‚æƒ…å†µ

- A çœ‹åˆ° B æ²¡æœ‰ä¸¾æ——
  - B ä¸€å®šä¸åœ¨ä¸´ç•ŒåŒº
  - æˆ–è€… B æƒ³è¿›ä½†è¿˜æ²¡æ¥å¾—åŠæŠŠ â€œA æ­£åœ¨ä½¿ç”¨â€ è´´åœ¨é—¨ä¸Š
- A çœ‹åˆ° B ä¸¾æ——å­
  - A ä¸€å®šå·²ç»æŠŠæ——å­ä¸¾èµ·æ¥äº†
  - `(!@^#&!%^(&^!@%#`

===== ç»•æ¥ç»•å»å¾ˆå®¹æ˜“æœ‰é”™æ¼çš„æƒ…å†µ

Prove by brute-force

æšä¸¾çŠ¶æ€æœºçš„å…¨éƒ¨çŠ¶æ€ (PC1,PC2,x,y,turn)
ä½†æ‰‹å†™è¿˜æ˜¯å¾ˆå®¹æ˜“é”™å•Šâ€”â€”å¯æ‰§è¡Œçš„çŠ¶æ€æœºæ¨¡å‹æœ‰ç”¨äº†ï¼

```c
void TA() { while (1) {
/* â¶ */  x = 1;
/* â· */  turn = B;
/* â¸ */  while (y && turn == B) ;
/* â¹ */  x = 0; } }

void TB() { while (1) {
/* â‘  */  y = 1;
/* â‘¡ */  turn = A;
/* â‘¢ */  while (x && turn == A) ;
/* â‘£ */  y = 0; } }
```

spin.py

```py
def T1():
  while heap.lock != 'âœ…':
    sys_sched()
  sys_sched()
  heap.lock = 'âŒ'
  sys_write('â¶')

def T2():
  while heap.lock != 'âœ…':
    sys_sched()
  sys_sched()
  heap.lock = 'âŒ'
  sys_write('â·')

def main():
  heap.lock = 'âœ…'
  sys_spawn(T1)
  sys_spawn(T2)

= Outputs:
= â¶â·
= â·â¶
```

== æ¨¡å‹ã€æ¨¡å‹æ£€éªŒä¸ç°å®

=== â€œPush-buttonâ€ Verification ğŸ–

æˆ‘ä»¬ (åœ¨å®Œå…¨ä¸ç†è§£ç®—æ³•çš„å‰æä¸‹) è¯æ˜äº† Sequential å†…å­˜æ¨¡å‹ä¸‹ Peterson's Protocol
çš„ Safetyã€‚å®ƒèƒ½å¤Ÿå®ç°äº’æ–¥ã€‚

å¹¶å‘ç¼–ç¨‹æ¯”å¤§å®¶æƒ³è±¡å¾—å›°éš¾

æ„Ÿå—ä¸€ä¸‹ [ Dekker's Algorithm
](https://series1.github.io/blog/dekkers-algorithm/) [ â€œMyths about the mutual
exclusion problemâ€ (IPL, 1981)
](https://zoo.cs.yale.edu/classes/cs323/doc/Peterson.pdf)

=== è‡ªåŠ¨éå†çŠ¶æ€ç©ºé—´çš„ä¹è¶£

å¯ä»¥å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿå›ç­”æ›´å¤šé—®é¢˜

- å¦‚æœç»“æŸåæŠŠé—¨ä¸Šçš„å­—æ¡æ’•æ‰ï¼Œç®—æ³•è¿˜æ­£ç¡®å—ï¼Ÿ
  - åœ¨æ”¾ä¸‹æ——å­ä¹‹å‰æ’•
  - åœ¨æ”¾ä¸‹æ——å­ä¹‹åæ’•
- å¦‚æœå…ˆè´´æ ‡ç­¾å†ä¸¾æ——ï¼Œç®—æ³•è¿˜æ­£ç¡®å—ï¼Ÿ
- æˆ‘ä»¬æœ‰ä¸¤ä¸ª â€œæŸ¥çœ‹â€ çš„æ“ä½œ
  - çœ‹å¯¹æ–¹çš„æ——æœ‰æ²¡æœ‰ä¸¾èµ·æ¥
  - çœ‹é—¨ä¸Šçš„è´´çº¸æ˜¯ä¸æ˜¯è‡ªå·±
  - è¿™ä¸¤ä¸ªæ“ä½œçš„é¡ºåºå½±å“ç®—æ³•çš„æ­£ç¡®æ€§å—ï¼Ÿ
- æ˜¯å¦å­˜åœ¨ â€œä¸¤ä¸ªäººè°éƒ½æ— æ³•è¿›å…¥ä¸´ç•ŒåŒºâ€ (liveness)ã€â€œå¯¹æŸä¸€æ–¹ä¸å…¬å¹³â€ (fairness)
  ç­‰è¡Œä¸ºï¼Ÿ
  - éƒ½è½¬æ¢æˆå›¾ (çŠ¶æ€ç©ºé—´) ä¸Šçš„éå†é—®é¢˜äº†ï¼ 

#tip("Tip")[
- å®Œå…¨ç†è§£éå¸¸å›°éš¾ï¼Œæ‰€ä»¥è¦å€ŸåŠ©model checker. 
- æœ‰åˆæ³•çŠ¶æ€ä»¥åŠéæ³•çŠ¶æ€ï¼Œå¦‚æœå­˜åœ¨åˆæ³•çŠ¶æ€->éæ³•çŠ¶æ€çš„ä¸€æ¡é€šè·¯ï¼Œå¯„ï¼ 
- ä¸å­˜åœ¨æ­»é”åº”è¯¥æ€ä¹ˆåœ¨çŠ¶æ€å›¾ä¸Šè¡¨ç¤ºï¼Ÿ
]

=== Model Checker å’Œè‡ªåŠ¨åŒ–

ç”µè„‘ä¸ºä»€ä¹ˆå« â€œç”µè„‘â€

- å°±æ˜¯å› ä¸ºå®ƒèƒ½æ›¿ä»£éƒ¨åˆ†äººç±»çš„æ€ç»´æ´»åŠ¨

å›å¿†ï¼šæ¯ä¸ªç­ä¸Šéƒ½æœ‰ä¸€ä¸ªç¬”è®°å’Œè‰ç¨¿çº¸éƒ½å·¥å·¥æ•´æ•´çš„ Ta

- è€å¸ˆï¼šå¸ƒç½®ä½œä¸šç”»çŠ¶æ€å›¾
  - Taï¼šè®¤è®¤çœŸçœŸé»˜é»˜ç”»å®Œ
    - å·¥æ•´çš„ç¬”è®°å¯ä»¥å¯å‘æ€ç»´
    - ä½† scale out éå¸¸å›°éš¾
  - æˆ‘ï¼šçƒ¦æ­»äº†ï¼åŠ³èµ„ä¸å¹²äº†ï¼ç©æ¸¸æˆå»äº†ï¼
    - è®¡ç®—æ€ç»´ï¼šå†™ä¸ªç¨‹åº (model checker) æ¥è¾…åŠ©
      - ä»»ä½•æœºæ¢°çš„æ€ç»´æ´»åŠ¨éƒ½å¯ä»¥ç”¨è®¡ç®—æœºæ›¿ä»£
      - AI è¿˜å¯ä»¥æ›¿ä»£å¯å‘å¼/ç»éªŒå¼çš„å†³ç­–

=== ä»æ¨¡å‹å›åˆ°ç°å®â€¦â€¦

å›åˆ°æˆ‘ä»¬çš„å‡è®¾ (ä½“ç°åœ¨æ¨¡å‹)

- Atomic load & store
  - è¯»/å†™å•ä¸ªå…¨å±€å˜é‡æ˜¯ â€œåŸå­ä¸å¯åˆ†å‰²â€ çš„
  - ä½†è¿™ä¸ªå‡è®¾åœ¨ç°ä»£å¤šå¤„ç†å™¨ä¸Šå¹¶ä¸æˆç«‹
- æ‰€ä»¥*å®é™…ä¸ŠæŒ‰ç…§æ¨¡å‹ç›´æ¥å†™ Peterson ç®—æ³•åº”è¯¥æ˜¯é”™çš„ï¼Ÿ*

â€œå®ç°æ­£ç¡®çš„ Peterson ç®—æ³•â€ æ˜¯åˆç†éœ€æ±‚ï¼Œå®ƒä¸€å®šèƒ½å®ç°

- Compiler barrier/volatile ä¿è¯ä¸è¢«ä¼˜åŒ–çš„å‰æä¸‹
  - å¤„ç†å™¨æä¾›ç‰¹æ®ŠæŒ‡ä»¤ä¿è¯å¯è§æ€§
  - ç¼–è¯‘å™¨æä¾› `__sync_synchronize()` å‡½æ•°
    - x86: `mfence;` ARM: `dmb ish;` RISC-V: `fence rw, rw`
    - åŒæ—¶å«æœ‰ä¸€ä¸ª compiler barrier

#tip("Tip")[
`x = 1`,`y=2`åœ¨æ­£å¸¸æƒ…å†µä¸‹å°±æœ‰å¯èƒ½è¢«ç¼–è¯‘å™¨ä¼˜åŒ–, ä¹±åºæ‰§è¡Œã€‚è€Œå¦‚æœå…ˆè´´åå­—å†ä¸¾æ——å­çš„è¯ï¼Œpetersonç®—æ³•æ˜¯é”™è¯¯çš„ã€‚
]

=== ğŸŒ¶ï¸ ç»´æŒå®ç°åˆ°æ¨¡å‹çš„å¯¹åº”

==== Peterson ç®—æ³•ï¼šC ä»£ç å®ç°æ¼”ç¤º

peterson.c

```c
#include "thread.h"

#define A 1
#define B 2

#define BARRIER __sync_synchronize()

atomic_int nested;
atomic_long count;

void critical_section() {
  long cnt = atomic_fetch_add(&count, 1);
  int i = atomic_fetch_add(&nested, 1) + 1;
  if (i != 1) {
    printf("%d threads in the critical section @ count=%ld\n", i, cnt);
    assert(0);
  }
  atomic_fetch_add(&nested, -1);
}

// x, yä»£è¡¨ä¸¾æ——å­ï¼Œ turnä»£è¡¨è´´åå­—
int volatile x = 0, y = 0, turn;

void TA() {
  while (1) {
    x = 1;                   BARRIER;
    turn = B;                BARRIER; // <- this is critcal for x86
    while (1) {
      if (!y) break;         BARRIER;
      if (turn != B) break;  BARRIER;
    }
    critical_section();
    x = 0;                   BARRIER;
  }
}

void TB() {
  while (1) {
    y = 1;                   BARRIER;
    turn = A;                BARRIER;
    while (1) {
      if (!x) break;         BARRIER;
      if (turn != A) break;  BARRIER;
    }
    critical_section();
    y = 0;                   BARRIER;
  }
}

int main() {
  create(TA);
  create(TB);
}
```

å¦‚æœpetersoné”™äº†, ä¾‹å¦‚æŠŠbarrieræ³¨é‡Šæ‰ã€‚

```
TA                  TB
lock()
t=++n(atomic)
                    t=++n(æ­¤æ—¶t=2)
n--(atomic)
unlock()
```

å¯ä»¥çœ‹åˆ°å¾ˆå¤šæ¬¡ä¹‹åæ‰ä¼šå‡ºç°é”™è¯¯ã€‚

å¦‚æœæŠŠ`barrier`æ”¹æˆ: `#define BARRIER asm volatile ("" ::: "memory")`
ä¹Ÿæ˜¯é”™è¯¯çš„ï¼Œä½†æ˜¯æ—¶é—´æ›´ä¹…ï¼Œè¿™ä¸ªbarrieræ›´å¼º.
`#define BARRIER asm volatile ("mfence" ::: "memory")`
`#define BARRIER __sync_synchronize()`

- ä¸€äº›æœ‰è¶£çš„é—®é¢˜
  - Compiler barrier èƒ½å¤Ÿç”¨å—ï¼Ÿ
  - å“ªäº›åœ°æ–¹çš„ barrier æ˜¯ä¸å¯å°‘çš„ï¼Ÿ
- æµ‹è¯•åªèƒ½è¯æ˜ â€œæœ‰é—®é¢˜â€ï¼Œä¸èƒ½è¯æ˜ â€œæ²¡é—®é¢˜â€

ç¼–è¯‘å™¨åˆ°åº•åšäº†ä»€ä¹ˆï¼Ÿ

- æ¨èï¼š#link("http://godbolt.org/")[ godbolt.org ]ï¼Œä½ ä¸ç”¨è£…é‚£äº› cross compiler äº†
  - ä½ ç”šè‡³å¯ä»¥çœ‹åˆ° compiler barrier æ˜¯å¦‚ä½•åœ¨ä¼˜åŒ–ä¸­ä¼ é€’çš„
    - å†ä¸€æ¬¡ï¼šè‡ªåŠ¨åŒ– & å¯è§†åŒ–çš„æ„ä¹‰
  - ä¸æ‡‚å¯ä»¥æŠŠä»£ç ç›´æ¥æ‰”ç»™ ChatGPT

== åŸå­æŒ‡ä»¤

=== å¹¶å‘ç¼–ç¨‹å›°éš¾çš„è§£å†³

å†™ä¸€ä¸ªæ­£ç¡®çš„æ— é”çš„å¹¶å‘ä»£ç éå¸¸éå¸¸å›°éš¾ã€‚(éœ€è¦å¯¹ç¼–è¯‘å™¨ï¼Œå¤„ç†å™¨ï¼Œç¼–ç¨‹è¯­è¨€éå¸¸éå¸¸äº†è§£).

æ™®é€šçš„å˜é‡è¯»å†™åœ¨ç¼–è¯‘å™¨ + å¤„ç†å™¨çš„åŒé‡ä¼˜åŒ–ä¸‹è¡Œä¸ºå˜å¾—å¤æ‚ã€‚é€šè¿‡åŸå­çš„`load()`,`store()`æ¥æ„é€ `lock()`å’Œ`unlock()`å·²ç»å®Œå…¨è¡Œä¸é€šã€‚

```c
retry:
  if (locked != UNLOCK) {
    goto retry;
  }
  locked = LOCK;
```

è§£å†³æ–¹æ³•ï¼šç¼–è¯‘å™¨å’Œç¡¬ä»¶å…±åŒæä¾›ä¸å¯ä¼˜åŒ–ã€ä¸å¯æ‰“æ–­çš„æŒ‡ä»¤

- â€œåŸå­æŒ‡ä»¤â€ + compiler barrier

=== å®ç°æ­£ç¡®çš„æ±‚å’Œ

```c
for (int i = 0; i < N; i++)
  asm volatile("lock incq %0" : "+m"(sum));
```

#tip("Tip")[
å¦‚æœæŠŠ`lock`å»æ‰ï¼Œé‚£å°±æ˜¯ä¸Šä¸€èŠ‚çš„`sum`. åŠ ä¸Šè¿™ä¸ª`lock`ä¹‹åï¼Œæ˜¾è‘—åœ°æ…¢äº†ã€‚
]

```
> gcc -O2 sum-atomic.c && time ./a.out
sum = 200000000
./a.out  3.80s user 0.00s system 199% cpu 1.910 total
> gcc -O2 sum-atomic.c && time ./a.out
sum = 108010081
./a.out  2.49s user 0.00s system 199% cpu 1.252 total
```

â€œBus lockâ€(æ€»çº¿é”)â€”â€”ä» 80386 å¼€å§‹å¼•å…¥ (bus control signal)
#image("images/2024-03-18-12-36-24.png")

`lock`çš„å®ç°ï¼Œå°±æ˜¯åœ¨å¼•è„šä¸Šé¢åŠ ä¸Šä¸€ä¸ª`lock`çš„ä¿¡å·çº¿(ä½ç”µå¹³æœ‰æ•ˆ). å½“æ‰§è¡Œ`lock`çš„æ—¶å€™ï¼Œè¯¥cpuå°±æœ‰äº†å†…å­˜çš„ç‹¬å è®¿é—®æƒ(åˆ«çš„CPUè¦è®¿é—®å†…å­˜éƒ½ä¸è¡Œï¼Œ
ç›´åˆ°å†æ¬¡è¢«æ‹‰é«˜)ã€‚

=== ğŸŒ¶ï¸ ç¼–è¯‘å™¨å’Œç¡¬ä»¶çš„åä½œ

Acquire/release semantics

- å¯¹äºä¸€å¯¹é…å¯¹çš„ release-acquire
  - (é€»è¾‘ä¸Š) release ä¹‹å‰çš„ store éƒ½å¯¹ acquire ä¹‹åçš„ load å¯è§
  - [ Making Sense of Acquire-Release Semantics
    ](https://davekilian.com/acquire-release.html)
- `std::atomic`
  - `std::memory_order_acquire`: guarantees that subsequent loads are not moved
    before the current load or any preceding loads.
  - `std::memory_order_release`: preceding stores are not moved past the current
    store or any subsequent stores.
  - `x.load()`/`x.store()` ä¼šæ ¹æ® [ memory order
    ](https://en.cppreference.com/w/cpp/atomic/memory_order) æ’å…¥ `fence`
  - `x.fetch_add()` å°†ä¼šä¿è¯ `cst` (sequentially consistent)
    - å» #link("https://godbolt.org/")[ godbolt ] ä¸Šè¯•ä¸€ä¸‹å§
