#import "../template.typ": *
#pagebreak()
= å¤šå¤„ç†å™¨ç¼–ç¨‹ï¼šä»å…¥é—¨åˆ°æ”¾å¼ƒ

== å¤šå¤„ç†å™¨ç¼–ç¨‹å…¥é—¨

=== Three Easy Pieces: å¹¶å‘

æ“ä½œç³»ç»Ÿä½œä¸º â€œçŠ¶æ€æœºçš„ç®¡ç†è€…â€ï¼Œå¼•å…¥äº†å…±äº«çš„çŠ¶æ€

- å¸¦æ¥äº†å¹¶å‘
- (æ“ä½œç³»ç»Ÿæ˜¯æœ€æ—©çš„å¹¶å‘ç¨‹åº)

```py
def Tprint(name):
    sys_write(f'{name}')

def main():
    for name in 'AB':
        sys_spawn(Tprint, name)

= Outputs:
= AB
= BA
```

ä½¿ç”¨ model checker ç»˜åˆ¶çŠ¶æ€å›¾

=== å¤šçº¿ç¨‹å…±äº«å†…å­˜å¹¶å‘

çº¿ç¨‹ï¼šå…±äº«å†…å­˜çš„æ‰§è¡Œæµ

- æ‰§è¡Œæµæ‹¥æœ‰ç‹¬ç«‹çš„å †æ ˆ/å¯„å­˜å™¨

ç®€åŒ–çš„çº¿ç¨‹ API (thread.h)

- `spawn(fn)` - åˆ›å»ºä¸€ä¸ªå…¥å£å‡½æ•°æ˜¯ fn çš„çº¿ç¨‹ï¼Œå¹¶ç«‹å³å¼€å§‹æ‰§è¡Œ - `void fn(int tid) { ... }` -
  å‚æ•° tid ä» 1 å¼€å§‹ç¼–å· è¡Œä¸ºï¼š`sys_spawn(fn, tid)`
- `join()`
  - ç­‰å¾…æ‰€æœ‰è¿è¡Œçº¿ç¨‹çš„è¿”å› (ä¹Ÿå¯ä»¥ä¸è°ƒç”¨)
  - è¡Œä¸ºï¼š`while (done != T) sys_sched()`

=== å¤šçº¿ç¨‹å…±äº«å†…å­˜å¹¶å‘ï¼šå…¥é—¨

å¤šå¤„ç†å™¨ç¼–ç¨‹ï¼šä¸€ä¸ª API æå®š

```c
#include "thread.h"

void Ta() { while (1) { printf("a"); } }
void Tb() { while (1) { printf("b"); } }

int main() {
  create(Ta);
  create(Tb);
}
```

- è¿™ä¸ªç¨‹åºå¯ä»¥åˆ©ç”¨ç³»ç»Ÿä¸­çš„å¤šå¤„ç†å™¨
  - æ“ä½œç³»ç»Ÿä¼šè‡ªåŠ¨æŠŠçº¿ç¨‹æ”¾ç½®åœ¨ä¸åŒçš„å¤„ç†å™¨ä¸Š
  - CPU ä½¿ç”¨ç‡è¶…è¿‡äº† 100%

==== demo

```c
#include "thread.h"

void Thello(int id) {
    while (1) {
        // printf("%c", "_ABCDEFGHIJKLMNOPQRSTUVWXYZ"[id]);
    }
}

int main() {
    for (int i = 0; i < 2; i++) {
        spawn(Thello);
    }
}
```

`gcc hello.c && ./a.out`, æ¥ç€`htop`å¯ä»¥çœ‹åˆ°å ç”¨äº† 200% çš„ cpu, æŠŠå¾ªç¯æ¬¡æ•°æ”¹æˆ 3
å°±å˜æˆäº† 300% .

=== é—®å‡ºæ›´å¤šçš„é—®é¢˜

_é—®ä¸€ä¸ªå¥½çš„é—®é¢˜å†å»å¯»æ‰¾ç­”æ¡ˆ, è¿™ä¸ªæ¯”å•çº¯åœ°å­¦ä¹ çŸ¥è¯†æ•ˆç‡æ›´é«˜._

==== è¯æ˜å…±äº«å†…å­˜

`Ta` å’Œ `Tb` çœŸçš„å…±äº«å†…å­˜å—ï¼Ÿ å¦‚ä½•è¯æ˜/å¦è¯è¿™ä»¶äº‹ï¼Ÿ

`shared_men.c`

```c
#include "thread.h"

int x = 0;

void Thello(int id) {
    x++;
    printf("%d\n", x);
}

int main() {
    for (int i = 0; i < 10; i++) {
        spawn(Thello);
    }
}
```

output:

```sh
â¯ gcc hello.c && ./a.out
1
3
2
5
4
6
7
8
9
10
```

==== å¦‚ä½•è¯æ˜çº¿ç¨‹å…·æœ‰ç‹¬ç«‹å †æ ˆ (ä»¥åŠç¡®å®šå †æ ˆçš„èŒƒå›´)ï¼Ÿ

å•çº¿ç¨‹çš„å †æ ˆ:

```
| stack      |
| stack down |
| heap up    |
| heap       |
| code       |
```

```c
#include "thread.h"

void add(int n) {
    int x = 0;
    x++;
    printf("x: %d\n", x);
}

int main(int argc, char *argv[]) {
    for (int i = 0; i < 10; i++) {
        spawn(add);
    }
    return 0;
}
```

output:

```sh
> gcc indp_stk.c && ./a.out
x: 1
x: 1
x: 1
x: 1
x: 1
x: 1
x: 1
x: 1
x: 1
x: 1
```

==== çº¿ç¨‹çš„å †æ ˆåœ¨å“ª?å¤šå¤§? å†™ä¸€ä¸ªç¨‹åºæ¥ç¡®å®š!(æ— ç©·é€’å½’!çˆ†æ ˆ)

stack-probe.c

```c
#include "thread.h"

void *volatile low[64];
void *volatile high[64];

void update_range(int T, void *ptr) {
    if (ptr < low[T]) low[T] = ptr;
    if (ptr > high[T]) high[T] = ptr;
}

void probe(int T, int n) {
    update_range(T, &n);
    long sz = (uintptr_t)high[T] - (uintptr_t)low[T];
    if (sz % 1024 < 32) {
        printf("Stack(T%d) >= %ld KB\n", T, sz / 1024);
    }
    probe(T, n + 1);  // Infinite recursion
}

void Tprobe(int T) {
    low[T] = (void *)-1;
    high[T] = (void *)0;
    update_range(T, &T);
    probe(T, 0);
}

int main() {
    setbuf(stdout, NULL);
    for (int i = 0; i < 4; i++) {
        create(Tprobe);
    }
}
```

===== `setbuf`?

```c
int main(){
    printf("%d",1);
    crash();
}
```

ä¸ºä»€ä¹ˆ`1`æ‰“å°ä¸å‡ºæ¥? å¦‚æœ`printf("%d",1);`æ¢æˆ`printf("%d\n",1);`å°±å¯ä»¥æ‰“å°å‡ºæ¥.
OS ä¼šç»™å‡ºç­”æ¡ˆ!

- å¯¹äºç»ˆç«¯ï¼ˆåŒ…æ‹¬
  stdinã€stdoutï¼‰ç­‰äº¤äº’å¼è®¾å¤‡ï¼Œé€šå¸¸é‡‡ç”¨è¡Œç¼“å†²ï¼šå³åªæœ‰å½“é‡åˆ°æ¢è¡Œç¬¦æˆ–è€…ç¼“å†²åŒºæ»¡æ—¶ï¼Œæ‰ä¼šè¿›è¡Œå®é™…çš„è¾“å…¥/è¾“å‡ºæ“ä½œã€‚
- å¯¹äºå…¶ä»–éäº¤äº’å¼è®¾å¤‡ï¼ˆå¦‚æ–‡ä»¶ã€ç®¡é“ç­‰ï¼‰ï¼Œé€šå¸¸é‡‡ç”¨å…¨ç¼“å†²ï¼šå³åªæœ‰å½“ç¼“å†²åŒºæ»¡æ—¶ï¼Œæ‰ä¼šè¿›è¡Œå®é™…çš„è¾“å…¥/è¾“å‡ºæ“ä½œã€‚

`setbuf` æ˜¯ C è¯­è¨€æ ‡å‡†åº“ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºè®¾ç½®æ–‡ä»¶æµçš„ç¼“å†²ç­–ç•¥ã€‚å…¶åŸå‹å¦‚ä¸‹ï¼š

```c
void setbuf(FILE *stream, char *buffer);
```

1. `stream`ï¼šè¿™æ˜¯ä¸€ä¸ªæŒ‡å‘ `FILE` ç±»å‹çš„æŒ‡é’ˆï¼Œè¡¨ç¤ºè¦è®¾ç½®ç¼“å†²ç­–ç•¥çš„æ–‡ä»¶æµã€‚
2. `buffer`ï¼šè¿™æ˜¯ä¸€ä¸ªæŒ‡å‘å­—ç¬¦çš„æŒ‡é’ˆï¼Œè¡¨ç¤ºè¦ç”¨ä½œç¼“å†²åŒºçš„å†…å­˜åœ°å€ã€‚å¦‚æœè¿™ä¸ªå‚æ•°ä¸º `NULL`ï¼Œé‚£ä¹ˆ `stream` å°†ä¸ä¼šæœ‰ç¼“å†²åŒºï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯æ¬¡è¯»å†™æ“ä½œéƒ½ä¼šç›´æ¥å¯¹æ–‡ä»¶è¿›è¡Œã€‚

åœ¨ C è¯­è¨€ä¸­ï¼Œæ–‡ä»¶ I/O æ“ä½œé€šå¸¸æ˜¯ç¼“å†²çš„, å³å½“ä½ è°ƒç”¨ä¸€ä¸ªè¾“å‡ºå‡½æ•°ï¼ˆæ¯”å¦‚ `printf` æˆ– `putchar`ï¼‰æ—¶ï¼Œæ•°æ®å¹¶ä¸æ˜¯ç«‹å³å†™å…¥æ–‡ä»¶ï¼Œè€Œæ˜¯å…ˆå†™å…¥ä¸€ä¸ªç¼“å†²åŒºã€‚åªæœ‰å½“ç¼“å†²åŒºæ»¡äº†ï¼Œæˆ–è€…ä½ æ˜¾å¼åœ°åˆ·æ–°ç¼“å†²åŒºï¼ˆæ¯”å¦‚é€šè¿‡è°ƒç”¨ `fflush`ï¼‰ï¼Œæ•°æ®æ‰ä¼šçœŸæ­£å†™å…¥æ–‡ä»¶ã€‚

#tip("Tip")[
éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ`setbuf` å¿…é¡»åœ¨æ‰“å¼€æ–‡ä»¶æµåã€è¿›è¡Œä»»ä½•å…¶ä»–æ“ä½œå‰è°ƒç”¨ã€‚å¦åˆ™ï¼Œå…¶è¡Œä¸ºæ˜¯æœªå®šä¹‰çš„ã€‚
]

```c
#include <stdio.h>
int main(int argc, char *argv[]) {
    setbuf(stdout, NULL);
    void *ptr = 0;
    printf("%d", 1);
    printf("%d", *(int *)ptr);
    return 0;
}
```

è¿™æ ·`1`ä¸éœ€è¦æ¢è¡Œç¬¦ä¹Ÿå¯ä»¥è¢«æˆåŠŸæ‰“å°å‡ºæ¥äº†!

===== continue stack-probe

```c
void *volatile low[64];
void *volatile high[64];
```

å‡è®¾ä¸è¶…è¿‡ 64 ä¸ªçº¿ç¨‹, `low`ä»£è¡¨çœ‹è§çš„æœ€ä½çš„åœ°å€çš„ä½ç½®, `high`ä»£è¡¨çœ‹è§çš„æœ€é«˜çš„åœ°å€çš„ä½ç½®.

```c
void update_range(int T, void *ptr) {
    if (ptr < low[T]) low[T] = ptr;
    if (ptr > high[T]) high[T] = ptr;
}

void probe(int T, int n) {
    update_range(T, &n);
    long sz = (uintptr_t)high[T] - (uintptr_t)low[T];
    if (sz % 1024 < 32) {
        printf("Stack(T%d) >= %ld KB\n", T, sz / 1024);
    }
    probe(T, n + 1);  // Infinite recursion
}

void Tprobe(int T) {
    low[T] = (void *)-1;
    high[T] = (void *)0;
    update_range(T, &T);
    probe(T, 0);
}
```

`Tprobe` ä¸­è°ƒç”¨`Tprobe`èµ‹åˆå€¼, low æ˜¯å½“å‰çœ‹åˆ°çš„æœ€ä½åœ°å€çš„ä½ç½®, `high`æ˜¯å½“å‰çœ‹åˆ°çš„æœ€é«˜åœ°å€çš„ä½ç½®.

`update_range` å‡½æ•°çš„å‚æ•° `ptr` æ˜¯ä¸€ä¸ªæŒ‡å‘æŸä¸ªå†…å­˜åœ°å€çš„æŒ‡é’ˆã€‚è¿™ä¸ªå‡½æ•°çš„ç›®çš„æ˜¯æ›´æ–°çº¿ç¨‹ `T` çš„æ ˆçš„æœ€ä½å’Œæœ€é«˜åœ°å€ã€‚

å½“ä½ åœ¨ `probe` å‡½æ•°ä¸­è°ƒç”¨ `update_range(T, &n);` æ—¶ï¼Œ`&n` æ˜¯å±€éƒ¨å˜é‡ `n` åœ¨æ ˆä¸Šçš„åœ°å€ã€‚å› ä¸ºæ¯æ¬¡é€’å½’è°ƒç”¨ `probe` éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ `n` å˜é‡ï¼Œæ‰€ä»¥ `n` çš„åœ°å€å¯ä»¥ç”¨æ¥è¿½è¸ªæ ˆçš„å¢é•¿ã€‚
å›åˆ° `update_range` å‡½æ•°ï¼Œå¦‚æœä¼ å…¥çš„ `ptr` æŒ‡å‘çš„åœ°å€æ¯”å½“å‰çº¿ç¨‹çš„æ ˆçš„æœ€ä½åœ°å€è¿˜è¦ä½ï¼Œé‚£ä¹ˆå°±å°† `low[T]` æ›´æ–°ä¸º `ptr`ã€‚åŒæ ·ï¼Œå¦‚æœ `ptr` æŒ‡å‘çš„åœ°å€æ¯”å½“å‰çº¿ç¨‹çš„æ ˆçš„æœ€é«˜åœ°å€è¿˜è¦é«˜ï¼Œé‚£ä¹ˆå°±å°† `high[T]` æ›´æ–°ä¸º `ptr`ã€‚
æ€»çš„æ¥è¯´ï¼Œ`ptr` å‚æ•°çš„ä½œç”¨æ˜¯æä¾›ä¸€ä¸ªå‚è€ƒç‚¹ï¼Œç”¨äºæ›´æ–°çº¿ç¨‹ `T` çš„æ ˆçš„æœ€ä½å’Œæœ€é«˜åœ°å€ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œç¨‹åºå¯ä»¥è¿½è¸ªæ¯ä¸ªçº¿ç¨‹æ ˆçš„ä½¿ç”¨æƒ…å†µã€‚

```sh
gcc stack-probe.c && ./a.out | grep T1 | sort -nk3
```

å¯ä»¥çœ‹åˆ° 8192KB, ä½†æ˜¯ 8192KB ä¸æ€»æ˜¯å¤Ÿç”¨çš„, äºæ˜¯å¯ä»¥è¿›ä¸€æ­¥é…ç½®çº¿ç¨‹æ ˆçš„å¤§å°.

- æ›´å¤šçš„ â€œå¥½é—®é¢˜â€ å’Œè§£å†³
  - åˆ›å»ºçº¿ç¨‹ä½¿ç”¨çš„æ˜¯å“ªä¸ªç³»ç»Ÿè°ƒç”¨ï¼Ÿ
    - èƒ½ä¸èƒ½ç”¨ gdb è°ƒè¯•ï¼Ÿ
    - åŸºæœ¬åŸåˆ™ï¼šæœ‰éœ€æ±‚ï¼Œå°±èƒ½åšåˆ° ([ RTFM
      ](https://sourceware.org/gdb/onlinedocs/gdb/Threads.html))

=== thread.h èƒŒåï¼šPOSIX Threads

æƒ³è¿›ä¸€æ­¥é…ç½®çº¿ç¨‹ï¼Ÿ

- è®¾ç½®æ›´å¤§çš„çº¿ç¨‹æ ˆ
- è®¾ç½® detach è¿è¡Œ (ä¸åœ¨è¿›ç¨‹ç»“æŸåè¢«æ€æ­»ï¼Œä¹Ÿä¸èƒ½ join)
- â€¦â€¦

POSIX ä¸ºæˆ‘ä»¬æä¾›äº†çº¿ç¨‹åº“ (pthreads)

- `man 7 pthreads`
- ç»ƒä¹ ï¼šæ”¹å†™ thread.hï¼Œä½¿å¾—çº¿ç¨‹æ‹¥æœ‰æ›´å¤§çš„æ ˆ
  - å¯ä»¥ç”¨ stack probe çš„ç¨‹åºéªŒè¯

== æ”¾å¼ƒ (1)ï¼šåŸå­æ€§

=== çŠ¶æ€æœºçš„éšå«å‡è®¾

â€œä¸–ç•Œä¸Šåªæœ‰ä¸€ä¸ªçŠ¶æ€æœºâ€

- æ²¡æœ‰å…¶ä»–ä»»ä½•äººèƒ½ â€œå¹²æ¶‰â€ ç¨‹åºçš„çŠ¶æ€
  - æ¨è®ºï¼šå¯¹å˜é‡çš„ load ä¸€å®šè¿”å›æœ¬çº¿ç¨‹æœ€åä¸€æ¬¡ store çš„å€¼
  - è¿™ä¹Ÿæ˜¯ç¼–è¯‘ä¼˜åŒ–çš„åŸºæœ¬å‡è®¾

```c
int i = 0;

// assume i==0;
for(; i < n; i++){
}
```

ä½†*å…±äº«å†…å­˜*æ¨ç¿»äº†è¿™ä¸ªå‡è®¾

```c
int Tworker() {
  printf("%d\n", x);  // Global x
  printf("%d\n", x);
}
```

- å…¶ä»–çº¿ç¨‹éšæ—¶å¯ä»¥ä¿®æ”¹ `x`
  - å¯¼è‡´ä¸¤æ¬¡å¯èƒ½è¯»åˆ°ä¸åŒçš„ `x`

=== æ½˜å¤šæ‹‰çš„é­”ç›’å·²ç»æ‰“å¼€â€¦â€¦

ä¸¤ä¸ªçº¿ç¨‹å¹¶å‘æ”¯ä»˜ Â¥100 ä¼šå‘ç”Ÿä»€ä¹ˆ (ä»£ç æ¼”ç¤º)

```c
#include "thread.h"

unsigned long balance = 100;

void Alipay_withdraw(int amt) {
    if (balance >= amt) {
        usleep(1);  // Unexpected delays
        balance -= amt;
    }
}

void Talipay(int id) { Alipay_withdraw(100); }

int main() {
    create(Talipay);
    create(Talipay);
    join();
    printf("balance = %lu\n", balance);
}
```

```sh
â¯ gcc alipay.c && ./a.out
balance = 18446744073709551516
```

- è´¦æˆ·é‡Œä¼šå¤šå‡ºç”¨ä¸å®Œçš„é’±ï¼
- Bug/æ¼æ´ä¸è·Ÿä½ å¼€ç©ç¬‘ï¼šMt. Gox Hack æŸå¤± 650,000 BTC
  - æ—¶å€¼ ~\$28,000,000,000

    ```c
    create(Talipay);
    ```

    ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿæ­£å¸¸

    ```c
    create(Talipay);
    join();
    create(Talipay);
    join();
    ```

    ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿæ­£å¸¸

#example("æ±‚å’Œ")[
åˆ†ä¸¤ä¸ªçº¿ç¨‹ï¼Œè®¡ç®— `1+1+1+â€¦+1` (å…±è®¡ `2n` ä¸ª `1`)

```c
#define N 100000000
long sum = 0;

void Tsum() { for (int i = 0; i < N; i++) sum++; }

int main() {
create(Tsum);
create(Tsum);
join();
printf("sum = %ld\n", sum);
}
```

å¯èƒ½çš„ç»“æœ

- `119790390`, `99872322` (ç»“æœå¯ä»¥æ¯” `N` è¿˜è¦å°), ...
- ç›´æ¥ä½¿ç”¨æ±‡ç¼–æŒ‡ä»¤ä¹Ÿä¸è¡Œ
]

=== æ”¾å¼ƒ (1)ï¼šæŒ‡ä»¤/ä»£ç æ‰§è¡ŒåŸå­æ€§å‡è®¾

_â€œå¤„ç†å™¨ä¸€æ¬¡æ‰§è¡Œä¸€æ¡æŒ‡ä»¤â€ çš„åŸºæœ¬å‡è®¾åœ¨ä»Šå¤©çš„è®¡ç®—æœºç³»ç»Ÿä¸Šä¸å†æˆç«‹ (æˆ‘ä»¬çš„æ¨¡å‹ä½œå‡ºäº†ç®€åŒ–çš„å‡è®¾)ã€‚_

- å•å¤„ç†å™¨å¤šçº¿ç¨‹
- çº¿ç¨‹åœ¨è¿è¡Œæ—¶å¯èƒ½è¢«ä¸­æ–­ï¼Œåˆ‡æ¢åˆ°å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œ
- å¤šå¤„ç†å™¨å¤šçº¿ç¨‹
- çº¿ç¨‹æ ¹æœ¬å°±æ˜¯å¹¶è¡Œæ‰§è¡Œçš„
- (å†å²) 1960sï¼Œå¤§å®¶äº‰å…ˆåœ¨å…±äº«å†…å­˜ä¸Šå®ç°åŸå­æ€§ (äº’æ–¥)
- ä½†å‡ ä¹æ‰€æœ‰çš„å®ç°éƒ½æ˜¯é”™çš„ï¼Œç›´åˆ° #link("https://en.wikipedia.org/wiki/Dekker's_algorithm")[ Dekker's Algorithm ]ï¼Œè¿˜åªèƒ½ä¿è¯ä¸¤ä¸ªçº¿ç¨‹çš„äº’æ–¥

=== æ”¾å¼ƒåŸå­æ€§å‡è®¾çš„åæœ

æˆ‘ä»¬éƒ½çŸ¥é“ `printf` æ˜¯æœ‰ç¼“å†²åŒºçš„ (ä¸ºä»€ä¹ˆï¼Ÿ), é‚£`printf` è¿˜èƒ½åœ¨å¤šçº¿ç¨‹ç¨‹åºé‡Œè°ƒç”¨å—ï¼Ÿå¦‚æœæ‰§è¡Œ `buf[pos++] = ch` (`pos` å…±äº«) ä¸å°± ğŸ’¥ äº†å—ï¼Ÿ

```c
void thread1() { while (1) { printf("a"); } }
void thread2() { while (1) { printf("b"); } }
```

RTFM! -> æˆ‘ä»¬å‘ç°`printf`æ˜¯thread safeçš„.

== æ”¾å¼ƒ (2)ï¼šæ‰§è¡Œé¡ºåº

=== ä¾‹å­ï¼šæ±‚å’Œ (å†æ¬¡å‡ºç°)

åˆ†ä¸¤ä¸ªçº¿ç¨‹ï¼Œè®¡ç®— 1+1+1+â€¦+1 (å…±è®¡ 2n ä¸ª 1)

```c
#define N 100000000
long sum = 0;

void Tsum() { for (int i = 0; i < N; i++) sum++; }

int main() {
create(Tsum);
create(Tsum);
join();
printf("sum = %ld\n", sum);
}
```

å¦‚æœæ·»åŠ ç¼–è¯‘ä¼˜åŒ–ï¼Ÿ

- -O1: 100000000 ğŸ˜±ğŸ˜±
- -O2: 200000000 ğŸ˜±ğŸ˜±ğŸ˜±

`gcc -O1 sum.c && objdump -d ./a.out > O1.txt`
`gcc -O2 sum.c && objdump -d ./a.out > O2.txt`

O1.txt:

```
000000000000117f <Tsum>:
117f: 48 8b 15 da 2e 00 00 mov 0x2eda(%rip),%rdx = 4060 <sum>

1186: 48 8d 42 01 lea 0x1(%rdx),%rax
118a: 48 81 c2 01 e1 f5 05 add $0x5f5e101,%rdx 1191: 48 89 c1 mov %rax,%rcx
1194: 48 83 c0 01 add $0x1,%rax
1198: 48 39 d0 cmp %rdx,%rax
119b: 75 f4 jne 1191 <Tsum+0x12>

119d: 48 89 0d bc 2e 00 00 mov %rcx,0x2ebc(%rip) = 4060 <sum>
11a4: c3 ret
```

ä¸­é—´æ˜¯ä¸ªå¾ªç¯ï¼Œ å¾ªç¯å®Œä¹‹åå†èµ‹å€¼

```
%rdx = sum

loop

sum = %rcx
```

O2.txt:

```
00000000000011e0 <Tsum>:
11e0: 48 81 05 75 2e 00 00 addq $0x5f5e100,0x2e75(%rip) = 4060 <sum> 11e7: 00 e1
f5 05 11eb: c3 ret 11ec: 0f 1f 40 00 nopl 0x0(%rax)
```

ç›´æ¥èµ‹å€¼, å¾ªç¯éƒ½æ²¡äº†ã€‚

```
sum += 0x5f5e100 ret
```

#tip("Tip")[
ä¸åŒçš„ç¼–è¯‘å™¨ä¹Ÿè®¸æ˜¯ä¸åŒåœ°ç»“æœã€‚
]

=== æ”¾å¼ƒ (2)ï¼šç¨‹åºçš„é¡ºåºæ‰§è¡Œå‡è®¾

_ç¼–è¯‘å™¨å¯¹å†…å­˜è®¿é—® â€œeventually consistentâ€ çš„å¤„ç†å¯¼è‡´å…±äº«å†…å­˜ä½œä¸ºçº¿ç¨‹åŒæ­¥å·¥å…·çš„å¤±æ•ˆã€‚_

åˆšæ‰çš„ä¾‹å­:

- -O1: `R[eax] = sum; R[eax] += N; sum = R[eax]`
- -O2: `sum += N;`
- (ä½ çš„ç¼–è¯‘å™¨ä¹Ÿè®¸æ˜¯ä¸åŒçš„ç»“æœ)

å¦ä¸€ä¸ªä¾‹å­

```c while (!done);// would be optimized to
if (!done) while (1);
```

==== ä¿è¯æ‰§è¡Œé¡ºåº

å›å¿† â€œç¼–è¯‘æ­£ç¡®æ€§â€

- C çŠ¶æ€å’Œæ±‡ç¼–çŠ¶æ€æœºçš„ â€œå¯è§‚æµ‹è¡Œä¸ºç­‰ä»·â€
- æ–¹æ³• 1ï¼šæ’å…¥ â€œä¸å¯ä¼˜åŒ–â€ ä»£ç 
  - `asm volatile ("" ::: "memory");`
    - â€œClobbers memoryâ€(è¯¥ä½ç½®ä¸Šå¯èƒ½æœ‰å…¶ä»–ä»»ä½•ä¸œè¥¿æ”¹å˜å…±äº«çš„å†…å­˜å€¼)
    ```c int x = 0; void Tsum() { x = 1; asm volatile("" ::: "memory"); x = 1; }
```
- æ–¹æ³• 2ï¼šæ ‡è®°å˜é‡ load/store ä¸ºä¸å¯ä¼˜åŒ–

  - ä½¿ç”¨ `volatile` å˜é‡

    ```c extern int volatile done;

while (!done) ;
```

== æ”¾å¼ƒ (3)ï¼šå¤„ç†å™¨é—´çš„å¯è§æ€§

#example("Example")[
```c int x = 0, y = 0;

void T1() { x = 1; int t = y;// Store(x); Load(y)
printf("%d", t); }

void T2() { y = 1; int t = x;// Store(y); Load(x)
printf("%d", t); }
```

éå†æ¨¡å‹å‘Šè¯‰æˆ‘ä»¬ï¼š`01`, `10`, `11`

- æœºå™¨æ°¸è¿œæ˜¯å¯¹çš„
- Model checker çš„ç»“æœå’Œå®é™…çš„ç»“æœä¸åŒ â†’ å‡è®¾é”™äº†
]

=== ğŸŒ¶ï¸ ç°ä»£å¤„ç†å™¨ä¹Ÿæ˜¯ (åŠ¨æ€) ç¼–è¯‘å™¨ï¼

- é”™è¯¯ (ç®€åŒ–) çš„å‡è®¾: ä¸€ä¸ª CPU æ‰§è¡Œä¸€æ¡æŒ‡ä»¤åˆ°è¾¾ä¸‹ä¸€çŠ¶æ€
- å®é™…çš„å®ç°:ç”µè·¯å°†è¿ç»­çš„æŒ‡ä»¤ â€œç¼–è¯‘â€ æˆæ›´å°çš„ $Î¼$ ops
  - `RF[9] = load(RF[7] + 400)`
  - `store(RF[12], RF[13])`
  - `RF[3] = RF[4] + RF[5]`

åœ¨ä»»ä½•æ—¶åˆ»ï¼Œå¤„ç†å™¨éƒ½ç»´æŠ¤ä¸€ä¸ª $Î¼$op çš„ â€œæ± å­â€

- ä¸ç¼–è¯‘å™¨ä¸€æ ·ï¼Œåš â€œé¡ºåºæ‰§è¡Œâ€ å‡è®¾ï¼šæ²¡æœ‰å…¶ä»–å¤„ç†å™¨ â€œå¹²æ‰°â€
- æ¯ä¸€å‘¨æœŸæ‰§è¡Œå°½å¯èƒ½å¤šçš„ $Î¼$op - å¤šè·¯å‘å°„ã€ä¹±åºæ‰§è¡Œã€æŒ‰åºæäº¤
  #tip("Tip")[
  é€šè¿‡æµæ°´çº¿å¯ä»¥å®ç°IPC>1, åŒæ—¶æ‰§è¡Œå¤šä¸ªæŒ‡ä»¤ã€‚
  ]

=== æ”¾å¼ƒ (3)ï¼šå¤šå¤„ç†å™¨é—´å†…å­˜è®¿é—®çš„å³æ—¶å¯è§æ€§

_æ»¡è¶³å•å¤„ç†å™¨ eventual memory consistency çš„æ‰§è¡Œï¼Œåœ¨å¤šå¤„ç†å™¨ç³»ç»Ÿä¸Šå¯èƒ½æ— æ³•åºåˆ—åŒ–ï¼_

å½“ `x != y` æ—¶ï¼Œå¯¹ x, y çš„å†…å­˜è¯»å†™å¯ä»¥äº¤æ¢é¡ºåº

- å®ƒä»¬ç”šè‡³å¯ä»¥åœ¨åŒä¸€ä¸ªå‘¨æœŸé‡Œå®Œæˆ (åªè¦ load/store unit æ”¯æŒ)
- å¦‚æœå†™ x å‘ç”Ÿ cache missï¼Œå¯ä»¥è®©è¯» y å…ˆæ‰§è¡Œ
  - æ»¡è¶³ â€œå°½å¯èƒ½æ‰§è¡Œ $Î¼$opâ€ çš„åŸåˆ™ï¼Œæœ€å¤§åŒ–å¤„ç†å™¨æ€§èƒ½

```
= <-----------+
movl $1, (x) = |
movl (y), %eax = --+
```

- åœ¨å¤šå¤„ç†å™¨ä¸Šçš„è¡¨ç°
- ä¸¤ä¸ªå¤„ç†å™¨åˆ†åˆ«çœ‹åˆ° y=0 å’Œ x=0

```
cpu1 cpu2 cpu3 cpu4
1:x=1 2:x=2 load(x) load(x)
=2 =1
=1 =2
```

=== å®½æ¾å†…å­˜æ¨¡å‹ (Relaxed/Weak Memory Model)

_å®½æ¾å†…å­˜æ¨¡å‹çš„ç›®çš„æ˜¯ä½¿å•å¤„ç†å™¨çš„æ‰§è¡Œæ›´é«˜æ•ˆã€‚_

ç›®å‰å„å¤§æ¶æ„çš„ç³»ç»Ÿæ¨¡æ‹Ÿå™¨æœ€å›°éš¾çš„åœ°æ–¹å°±æ˜¯æ¨¡æ‹Ÿå†…å­˜æ¨¡å‹, ä»–ä»¬ä¸çŸ¥é“å“ªä¸ªåœ°æ–¹ä¼šè¢«æ’å…¥æ‰§è¡Œï¼Œ åªèƒ½æ¯è¡Œä»£ç éƒ½åŠ ä¸€ä¸ª`fence`ã€‚

#tip("Tip")[
x86 å·²ç»æ˜¯å¸‚é¢ä¸Šèƒ½ä¹°åˆ°çš„ â€œæœ€å¼ºâ€ çš„å†…å­˜æ¨¡å‹äº† ğŸ˜‚
]

- è¿™ä¹Ÿæ˜¯ Intel è‡ªå·±ç»™è‡ªå·±åŠ çš„åŒ…è¢±
- çœ‹çœ‹ #link("https://research.swtch.com/mem-weak@2x.png")[ ARM/RISC-V ] å§ï¼Œæ ¹æœ¬å°±æ˜¯ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿ
#image("images/2023-11-04-10-15-39.png")
#tip("Tip")[
- é€šè¿‡é˜Ÿåˆ—, å¯ä»¥çœ‹åˆ°total store order.
- å…¨å±€çŠ¶æ€ï¼š`1 2`è¿˜æ˜¯`2 1`
]

(x86-TSO in #link("https://research.swtch.com/hwmm")[ Hardware memory models ] by Russ Cox)
