#import "../template.typ": *
#pagebreak()
= Python å»ºæ¨¡æ“ä½œç³»ç»Ÿ

== ç†è§£æ“ä½œç³»ç»Ÿçš„æ–°é€”å¾„

=== å›é¡¾ï¼šç¨‹åº/ç¡¬ä»¶çš„çŠ¶æ€æœºæ¨¡å‹

è®¡ç®—æœºè½¯ä»¶

- çŠ¶æ€æœº (C/æ±‡ç¼–)
  - å…è®¸æ‰§è¡Œç‰¹æ®ŠæŒ‡ä»¤ (syscall) è¯·æ±‚æ“ä½œç³»ç»Ÿ
  - æ“ä½œç³»ç»Ÿ = API + å¯¹è±¡

è®¡ç®—æœºç¡¬ä»¶

- â€œæ— æƒ…æ‰§è¡ŒæŒ‡ä»¤çš„æœºå™¨â€
  - ä» CPU Reset çŠ¶æ€å¼€å§‹æ‰§è¡Œ Firmware ä»£ç 
  - æ“ä½œç³»ç»Ÿ = C ç¨‹åº

=== ä¸€ä¸ªå¤§èƒ†çš„æƒ³æ³•

æ— è®ºæ˜¯è½¯ä»¶è¿˜æ˜¯ç¡¬ä»¶ï¼Œéƒ½æ˜¯çŠ¶æ€æœº

- è€ŒçŠ¶æ€å’ŒçŠ¶æ€çš„è¿ç§»æ˜¯å¯ä»¥ â€œç”»â€ å‡ºæ¥çš„ï¼
- ç†è®ºä¸Šè¯´ï¼Œåªéœ€è¦ä¸¤ä¸ª API
  - `dump_state()` - è·å–å½“å‰ç¨‹åºçŠ¶æ€
  - `single_step()` - æ‰§è¡Œä¸€æ­¥
  - `gdb` ä¸å°±æ˜¯åšè¿™ä¸ªçš„å—ï¼

=== GDB æ£€æŸ¥çŠ¶æ€çš„ç¼ºé™·

å¤ªå¤æ‚

- çŠ¶æ€å¤ªå¤š (æŒ‡ä»¤æ•°å¾ˆå¤š)
- çŠ¶æ€å¤ªå¤§ (å¾ˆå¤šåº“å‡½æ•°çŠ¶æ€)

ç®€åŒ–ï¼šæŠŠå¤æ‚çš„ä¸œè¥¿åˆ†è§£æˆç®€å•çš„ä¸œè¥¿

- åœ¨ã€Šæ“ä½œç³»ç»Ÿã€‹è¯¾ä¸Šï¼Œç®€åŒ–æ˜¯éå¸¸é‡è¦çš„ä¸»é¢˜, å¦åˆ™å®¹æ˜“è¿·å¤±åœ¨ç»†èŠ‚çš„æµ·æ´‹ä¸­,
  ä¸€äº›å…·ä½“çš„ä¾‹å­:
  - åªå…³æ³¨ç³»ç»Ÿè°ƒç”¨ (strace)
    - `strace`æŠŠæŒ‡ä»¤ç®€åŒ–ä¸ºä¸¤ç§,ä¸€ç§è®¡ç®—æŒ‡ä»¤(ä¸å…³å¿ƒ),å¦ä¸€ç§æ˜¯ system call(å…³å¿ƒ)çš„æŒ‡ä»¤,
      è¿™ç§ç®€åŒ–å¯ä»¥çœ‹åˆ°è½¯ä»¶å’Œæ“ä½œç³»ç»Ÿè¾¹ç•Œåœ¨å‘ç”Ÿä»€ä¹ˆ.
  - Makefile çš„å‘½ä»¤æ—¥å¿—
  - strace/Makefile æ—¥å¿—çš„æ¸…ç†

=== ä¸€ä¸ªæƒ³æ³•ï¼šåæ­£éƒ½æ˜¯çŠ¶æ€æœºâ€¦â€¦

ä¸ç®¡ C è¯­è¨€è¿˜æ˜¯æ±‡ç¼–è¯­è¨€, éƒ½æ˜¯çŠ¶æ€æœº.æ±‡ç¼–è¯­è¨€çš„çŠ¶æ€æœºå¤ªå¤æ‚, å¯ä»¥æŠŠå…¶ç®€åŒ–æˆ C
è¯­è¨€. C è¯­è¨€è¿˜å¤ªå¤æ‚, æˆ‘ä»¬è¿˜å¯ä»¥å†ç®€åŒ–: æˆ‘ä»¬åªå…³å¿ƒä¸¤ä¸ªä¸œè¥¿, ä¸€ä¸ªæ˜¯çº¯ç²¹çš„è®¡ç®—,
è¿˜æœ‰ä¸€ä¸ªå°±æ˜¯ç³»ç»Ÿè°ƒç”¨. æˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªæ›´ç®€åŒ–çš„è¯­è¨€.

æˆ‘ä»¬çœŸæ­£å…³å¿ƒçš„æ¦‚å¿µ

- åº”ç”¨ç¨‹åº (é«˜çº§è¯­è¨€çŠ¶æ€æœº)
- ç³»ç»Ÿè°ƒç”¨ (æ“ä½œç³»ç»Ÿ API)
- æ“ä½œç³»ç»Ÿå†…éƒ¨å®ç°

æ²¡æœ‰äººè§„å®šä¸Šé¢ä¸‰è€…å¦‚ä½•å®ç°

- é€šå¸¸çš„æ€è·¯ï¼šçœŸå®çš„æ“ä½œç³»ç»Ÿ + QEMU/NEMU æ¨¡æ‹Ÿå™¨, æˆ‘ä»¬çš„æ€è·¯
- åº”ç”¨ç¨‹åº = çº¯ç²¹è®¡ç®—çš„ Python ä»£ç  + ç³»ç»Ÿè°ƒç”¨
- æ“ä½œç³»ç»Ÿ = Python ç³»ç»Ÿè°ƒç”¨å®ç°ï¼Œæœ‰ â€œå‡æƒ³â€ çš„ I/O è®¾å¤‡

```py
def main():
    sys_write('Hello, OS World')
```

== æ“ä½œç³»ç»Ÿ â€œç©å…·â€ï¼šè®¾è®¡ä¸å®ç°

=== æ“ä½œç³»ç»Ÿç©å…·ï¼šAPI

å››ä¸ª â€œç³»ç»Ÿè°ƒç”¨â€ API

- `choose(xs)`: è¿”å› xs ä¸­çš„ä¸€ä¸ªéšæœºé€‰é¡¹
- `write(s)`: è¾“å‡ºå­—ç¬¦ä¸² s
- `spawn(fn)`: åˆ›å»ºä¸€ä¸ªå¯è¿è¡Œçš„çŠ¶æ€æœº fn
- `sched()`: éšæœºåˆ‡æ¢åˆ°ä»»æ„çŠ¶æ€æœºæ‰§è¡Œ

é™¤æ­¤ä¹‹å¤–ï¼Œæ‰€æœ‰çš„ä»£ç éƒ½æ˜¯ç¡®å®š (deterministic) çš„çº¯ç²¹è®¡ç®—, å…è®¸ä½¿ç”¨ list, dict
ç­‰æ•°æ®ç»“æ„

=== æ“ä½œç³»ç»Ÿç©å…·ï¼šåº”ç”¨ç¨‹åº

æ“ä½œç³»ç»Ÿé‡Œé¢å¯ä»¥è¿è¡Œä¸æ­¢ä¸€ä¸ªç¨‹åº, ä¹Ÿå°±æ˜¯ os å¯ä»¥åŒæ—¶å®¹çº³å¥½å‡ ä¸ªçŠ¶æ€æœº.
æ‰€ä»¥æœ€æœ‰æ„æ€çš„æ˜¯`spawn(fn)`å’Œ`sched()`è¿™ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨.

æ“ä½œç³»ç»Ÿç©å…·ï¼šæˆ‘ä»¬å¯ä»¥åŠ¨æ‰‹æŠŠçŠ¶æ€æœºç”»å‡ºæ¥ï¼

```py
count = 0

def Tprint(name):
    global count
    for i in range(3):
        count += 1
        sys_write(f'#{count:02} Hello from {name}{i+1}\n')
        sys_sched()

def main():
    n = sys_choose([3, 4, 5])
    sys_write(f'#Thread = {n}\n')
    for name in 'ABCDE'[:n]:
        sys_spawn(Tprint, name)
    sys_sched()
```

#tip("Tip")[
- æ–‡ä»¶æ˜¯æ“ä½œç³»ç»Ÿçš„å¯¹è±¡, æ–‡ä»¶æè¿°ç¬¦å°±æ˜¯ä¸€ä¸ªæŒ‡å‘æ“ä½œç³»ç»Ÿå¯¹è±¡çš„æŒ‡é’ˆ.
- è¿›ç¨‹å’Œçº¿ç¨‹ä¹Ÿæ˜¯æ“ä½œç³»ç»Ÿçš„ä¸€ä¸ªéå¸¸é‡è¦çš„å¯¹è±¡, å³æ‰§è¡Œçš„çŠ¶æ€æœº.çº¿ç¨‹å…±äº«å†…å­˜, è¿›ç¨‹æœ‰ç‹¬ç«‹çš„å†…å­˜.
]

çŠ¶æ€æœº:

```
s0(ptr->{pc=.., n=3}, {Tp=1A},{Tp=1B},{Tp=1C})
--sched-->  s0({pc=.., n=3}, {Tp=1A},ptr->{Tp=1B},{Tp=1C})
--write-->  s0({pc=.., n=3}, {Tp=1A},ptr->{Tp=1B},{Tp=1C}, stdout='#1 Hello from B1')
```

```sh
â¯ ./os-model.py threads.py
#Thread = 4
#01 Hello from C1
#02 Hello from A1
#03 Hello from A2
#04 Hello from D1
#05 Hello from B1
#06 Hello from B2
#07 Hello from B3
#08 Hello from C2
#09 Hello from A3
#10 Hello from D2
#11 Hello from C3
#12 Hello from D3
```

=== å®ç°ç³»ç»Ÿè°ƒç”¨

æœ‰äº› â€œç³»ç»Ÿè°ƒç”¨â€ çš„å®ç°æ˜¯æ˜¾è€Œæ˜“è§çš„

```py
def sys_write(s): print(s)
def sys_choose(xs): return random.choice(xs)
def sys_spawn(t): runnables.append(t)
```

æœ‰äº›å°±å›°éš¾äº†

```py
def sys_sched():
    raise NotImplementedError('No idea how')
```

#tip("Tip")[
`NotImplementedError`æ˜¯ä¸ªå¥½çš„ä¹ æƒ¯.
]

æˆ‘ä»¬éœ€è¦

- å°å­˜å½“å‰çŠ¶æ€æœºçš„çŠ¶æ€
- æ¢å¤å¦ä¸€ä¸ª â€œè¢«å°å­˜â€ çŠ¶æ€æœºçš„æ‰§è¡Œ
  - æ²¡é”™ï¼Œæˆ‘ä»¬ç¦»çœŸæ­£çš„ â€œåˆ†æ—¶æ“ä½œç³»ç»Ÿâ€ å°±åªå·®è¿™ä¸€æ­¥

==== ï¸ğŸŒ¶ï¸ å€Ÿç”¨ Python çš„è¯­è¨€æœºåˆ¶

Generator objects (æ— æ ˆåç¨‹/è½»é‡çº§çº¿ç¨‹/...)

```py
def numbers():
    i = 0
    while True:
        ret = yield f'{i:b}'  = â€œå°å­˜â€ çŠ¶æ€æœºçŠ¶æ€
        i += ret
```

ä½¿ç”¨æ–¹æ³•ï¼š

```py
n = numbers()  = å°å­˜çŠ¶æ€æœºåˆå§‹çŠ¶æ€
n.send(None)  = æ¢å¤å°å­˜çš„çŠ¶æ€
n.send(0)  = æ¢å¤å°å­˜çš„çŠ¶æ€ (å¹¶ä¼ å…¥è¿”å›å€¼)
```

å®Œç¾é€‚åˆæˆ‘ä»¬å®ç°æ“ä½œç³»ç»Ÿç©å…· (os-model.py)

=== ç©å…·çš„æ„ä¹‰

æˆ‘ä»¬å¹¶æ²¡æœ‰è„±ç¦»çœŸå®çš„æ“ä½œç³»ç»Ÿ

- â€œç®€åŒ–â€ äº†æ“ä½œç³»ç»Ÿçš„ API
  - åœ¨æš‚æ—¶ä¸è¦è¿‡åº¦å…³æ³¨ç»†èŠ‚çš„æ—¶å€™ç†è§£æ“ä½œç³»ç»Ÿ
- ç»†èŠ‚ä¹Ÿä¼šæœ‰çš„ï¼Œä½†ä¸æ˜¯ç°åœ¨
  - å­¦ä¹ è·¯çº¿ï¼šå…ˆ 100% ç†è§£ç©å…·ï¼Œå†ç†è§£çœŸå®ç³»ç»Ÿå’Œç©å…·çš„å·®å¼‚

```c
void sys_write(const char *s) { printf("%s", s); }
void sys_sched() { usleep(rand() % 10000); }
int sys_choose(int x) { return rand() % x; }

void sys_spawn(void *(*fn)(void *), void *args) {
    pthread_create(&threads[nthreads++], NULL, fn, args);
}
```

== å»ºæ¨¡æ“ä½œç³»ç»Ÿ

=== ä¸€ä¸ªæ›´ â€œå…¨é¢â€ çš„æ“ä½œç³»ç»Ÿæ¨¡å‹

è¿›ç¨‹ + çº¿ç¨‹ + ç»ˆç«¯ + å­˜å‚¨ (å´©æºƒä¸€è‡´æ€§)

| ç³»ç»Ÿè°ƒç”¨/Linux å¯¹åº” | è¡Œä¸º | | -------------------------------- |
------------------------------ | | `sys_spawn(fn)`/`pthread_create` | åˆ›å»ºä» fn
å¼€å§‹æ‰§è¡Œçš„çº¿ç¨‹ | | `sys_fork()`/`fork` | åˆ›å»ºå½“å‰çŠ¶æ€æœºçš„å®Œæ•´å¤åˆ¶ | | `sys_sched()`/å®šæ—¶è¢«åŠ¨è°ƒç”¨
| åˆ‡æ¢åˆ°éšæœºçš„çº¿ç¨‹/è¿›ç¨‹æ‰§è¡Œ | | `sys_choose(xs)`/`rand` | è¿”å›ä¸€ä¸ª xs
ä¸­çš„éšæœºçš„é€‰æ‹© | | `sys_write(s)`/`printf` | å‘è°ƒè¯•ç»ˆç«¯è¾“å‡ºå­—ç¬¦ä¸² s | | `sys_bread(k)`/`read` |
è¯»å–è™šæ‹Ÿè®¾ç£ç›˜å— k çš„æ•°æ® | | `sys_bwrite(k, v)`/`write` | å‘è™šæ‹Ÿç£ç›˜å— k
å†™å…¥æ•°æ® v | | `sys_sync()`/`sync` | å°†æ‰€æœ‰å‘è™šæ‹Ÿç£ç›˜çš„æ•°æ®å†™å…¥è½ç›˜ | | `sys_crash()`/é•¿æŒ‰ç”µæºæŒ‰é”®
| æ¨¡æ‹Ÿç³»ç»Ÿå´©æºƒ |

=== æ¨¡å‹åšå‡ºçš„ç®€åŒ–

- è¢«åŠ¨è¿›ç¨‹/çº¿ç¨‹åˆ‡æ¢: å®é™…ç¨‹åºéšæ—¶éƒ½å¯èƒ½è¢«åŠ¨è°ƒç”¨ `sys_sched()` åˆ‡æ¢
- åªæœ‰ä¸€ä¸ªç»ˆç«¯: æ²¡æœ‰ `read()` (ç”¨ `choose` æ›¿ä»£ â€œå…è®¸è¯»åˆ°ä»»æ„å€¼â€)
- ç£ç›˜æ˜¯ä¸€ä¸ª dict:
  - æŠŠä»»æ„ key æ˜ å°„åˆ°ä»»æ„ value
  - å®é™…çš„ç£ç›˜
    - key ä¸ºæ•´æ•°
    - value æ˜¯å›ºå®šå¤§å° (ä¾‹å¦‚ 4KB) çš„æ•°æ®
    - äºŒè€…åœ¨æŸç§ç¨‹åº¦ä¸Šæ˜¯å¯ä»¥ â€œäº’ç›¸è½¬æ¢â€ çš„

=== æ¨¡å‹å®ç°

åŸç†ä¸åˆšæ‰çš„ â€œæœ€å°æ“ä½œç³»ç»Ÿç©å…·â€ ç±»ä¼¼

- #link("https://jyywiki.cn/pages/OS/2023/mosaic/mosaic.py")[ mosaic.py ] - 500
  è¡Œå»ºæ¨¡æ“ä½œç³»ç»Ÿ
- è¿›ç¨‹/çº¿ç¨‹éƒ½æ˜¯ Generator Object
- å…±äº«å†…å­˜ç”¨ heap å˜é‡è®¿é—®
  - çº¿ç¨‹ä¼šå¾—åˆ°å…±äº« heap çš„æŒ‡é’ˆ
  - è¿›ç¨‹ä¼šå¾—åˆ°ä¸€ä¸ªç‹¬ç«‹çš„ heap clone

è¾“å‡ºç¨‹åºè¿è¡Œçš„ â€œçŠ¶æ€å›¾â€

- JSON Object
- Vertices: çº¿ç¨‹/è¿›ç¨‹ã€å†…å­˜å¿«ç…§ã€è®¾å¤‡å†å²è¾“å‡º
- Edges: ç³»ç»Ÿè°ƒç”¨
  - æ“ä½œç³»ç»Ÿå°±æ˜¯ â€œçŠ¶æ€æœºçš„ç®¡ç†è€…â€

=== å»ºæ¨¡çš„æ„ä¹‰

æˆ‘ä»¬å¯ä»¥æŠŠçŠ¶æ€æœºçš„æ‰§è¡Œç”»å‡ºæ¥äº†ï¼

- å¯ä»¥ç›´è§‚åœ°ç†è§£ç¨‹åºæ‰§è¡Œçš„å…¨æµç¨‹
- å¯ä»¥å¯¹ç…§ç¨‹åºåœ¨çœŸå®æ“ä½œç³»ç»Ÿä¸Šçš„è¿è¡Œç»“æœ è¿™å¯¹äºæ›´å¤æ‚çš„ç¨‹åºæ¥è¯´æ˜¯ååˆ†å…³é”®çš„

```c
void Tsum() {
  for (int i = 0; i < n; i++) {
    int tmp = sum;
    tmp++;
    // å‡è®¾æ­¤æ—¶å¯èƒ½å‘ç”Ÿè¿›ç¨‹/çº¿ç¨‹åˆ‡æ¢
    sum = tmp;
  }
}
```

å‡è®¾10ä¸ªçº¿ç¨‹, æ¯ä¸ªçº¿ç¨‹éƒ½å¾€sumä¸Š+10, sumçš„å€¼æœ€å°å¯ä»¥æ˜¯å¤šå°‘?
å…¶ä¸­ä¸€ä¸ªå¾ªç¯è·‘åˆ°æœ€åä¸€æ¬¡å¾ªç¯ç„¶åè¯»åˆ°ä¸€ä¸ª1, tmp++å˜æˆ2,
ç„¶åç­‰å…¶ä»–çº¿ç¨‹éƒ½è·‘å®Œå†å†™å…¥è¿›å».æ•…è€Œæœ€å°å€¼æ˜¯ 2.

== ç¼–ç¨‹å®è·µ

=== demo1

```py
def main():
    x = sys_choose(['Head', 'Tail'])
    x = x.lower()
    sys_write('Hello, OS World')
```

#tip("Tip")[
ä¸ºä»€ä¹ˆ `choose` æ˜¯ç³»ç»Ÿè°ƒç”¨, å› ä¸ºä¸ä¾é å¤–ç•Œ, æ˜¯ä¸å¯èƒ½é çº¯ç²¹çš„è®¡ç®—æ¥å®ç°çœŸæ­£çš„éšæœºæ•°çš„.
]

py ç¨‹åºçŠ¶æ€æœº:

```
s0
--choose-->   s1(x='Head')
--cal-->      s2(x='head')
--write-->    s3(x='head)
```

å‘ç°å¯¹è¿™ä¸ªç¨‹åºçŠ¶æ€æœºæ¥è¯´, s3 å’Œ s2 ä¸€æ ·, æ²¡æœ‰ä»»ä½•å¯è§‚æµ‹çš„æ•ˆæœ.

æ“ä½œç³»ç»ŸçŠ¶æ€æœºçš„è§†è§’:

```
s0(stdout ='')
--choose--> s1(x='Head', stdout='')
--cal-->    s2(x='head', stdout='')
--write-->  s3(x='head', stdout='head')
```

æ“ä½œç³»ç»Ÿé‡Œé¢å¯ä»¥è¿è¡Œä¸æ­¢ä¸€ä¸ªç¨‹åº, ä¹Ÿå°±æ˜¯ os å¯ä»¥åŒæ—¶å®¹çº³å¥½å‡ ä¸ªçŠ¶æ€æœº.

```py
def fn():
  pass
def main():
  = åˆ›å»ºäº†ä¸€ä¸ªçŠ¶æ€æœº
  sys_spawn(fn)
```

æ“ä½œç³»ç»ŸçŠ¶æ€æœº:

```
s0({ pc=main->1 })
--spawn-->  s3({ pc=main->2 },{ pc=fn->1 })
```

é—®é¢˜: ä¸‹ä¸€æ­¥è¯¥æ‰§è¡Œå“ªä¸ªçŠ¶æ€æœº?å¢åŠ ä¸€ä¸ªæŒ‡é’ˆ, é»˜è®¤æƒ…å†µæ˜¯ä¸å˜çš„.ä½†æ˜¯`sched()`åä¼šéšæœºåˆ‡æ¢.

```
s0(ptr->{pc=main->1})
--spawn-->  s3(ptr->{ pc=main->2 },{ pc=fn->1 })
--sched-->  s3({ pc=main->2 }, ptr->{ pc=fn->1 })
```

=== python çš„ generator

```py
â¯ python3
Python 3.10.12 (main, Jun 11 2023, 05:26:28) [GCC 11.4.0] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> def numbers():
...     i = 0
...     while True:
...             ret = yield f'{i:b}'  = â€œå°å­˜â€ çŠ¶æ€æœºçŠ¶æ€
...             i += ret
...
>>> n = numbers()
>>> type(n)
<class 'generator'>
>>> n.send(None)
'0'
>>> n.send(1)
'1'
>>> n.send(1)
'10'
>>> n.send(1)
'11'
>>> n.send(1)
'100'
>>> n.send(1)
'101'
>>> n.send(100)
'1101001'
>>> m = numbers()
>>> m.send(None)
'0'
>>> m.send(1)
'1'
>>> n.send(1)
'1101010'
```

#tip("Tip")[
generator å°±æ˜¯ä¸€ä¸ªçŠ¶æ€æœº. ä¸€ç§æ˜¯çº¯ç²¹çš„è®¡ç®—, ä¸€ç§æ˜¯ç³»ç»Ÿè°ƒç”¨, åœ¨ generator é‡Œé¢å°±æ˜¯ yield.`yield`å¯ä»¥æŠŠé‡Œé¢çš„ä¿¡æ¯æš´éœ²ç»™å¤–é¢, ç„¶åæŠŠæ§åˆ¶æƒäº¤ç»™å¤–é¢.å¤–é¢è¿˜å¯ä»¥æŠŠä¿¡æ¯ä¼ å›æ¥.
]

#tip("Tip")[
æ€ä¹ˆå†™ä¸€ä¸ªè£…é¥°å™¨?
]

=== C è¯­è¨€ç‰ˆç©å…·

```c
static inline void
sys_sched() {
  usleep(rand() % 10000);
}

// Constructor called before main()
static inline void __attribute__((constructor))
srand_init() {
  srand(time(0));
}

// Destructor called after main()
static inline void __attribute__((destructor))
thread_join() {
  for (int i = 0; i < nthreads; i++) {
    pthread_join(threads[i], NULL);  // Wait for thread terminations
  }
}
```

ä¸ºä»€ä¹ˆ`sched`æ˜¯éšæœºç¡çœ ?

è¿™é‡Œçš„`constructor`å’Œ`destructor`æ˜¯ä¸ºäº†é˜²æ­¢:

```c
int main(){
  ...
  if(..){
    return 1
  }

  release_res();
}
```

è¿™ç§æƒ…å†µçš„èµ„æºæ³„éœ².
