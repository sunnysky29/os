#import "../template.typ": *
#pagebreak()
= å¹¶å‘æ§åˆ¶ï¼šåŒæ­¥ (1)

== åŒæ­¥é—®é¢˜

=== åŒæ­¥ (Synchronization)

ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šéšæ—¶é—´å˜åŒ–çš„é‡åœ¨å˜åŒ–è¿‡ç¨‹ä¸­ä¿æŒä¸€å®šçš„ç›¸å¯¹å…³ç³»

- åŒæ­¥ç”µè·¯ (ä¸€ä¸ªæ—¶é’Ÿæ§åˆ¶æ‰€æœ‰è§¦å‘å™¨)
- iPhone/iCloud åŒæ­¥ (æ‰‹æœº vs ç”µè„‘ vs äº‘ç«¯)
- å˜é€Ÿç®±åŒæ­¥å™¨ (åˆå¹¶å¿«æ…¢é€Ÿé½¿è½®)
- åŒæ­¥ç”µæœº (è½¬å­ä¸ç£åœºè½¬é€Ÿä¸€è‡´)
- åŒæ­¥ç”µè·¯ (æ‰€æœ‰è§¦å‘å™¨åœ¨è¾¹æ²¿åŒæ—¶è§¦å‘)

å¼‚æ­¥ (Asynchronous) = ä¸éœ€è¦åŒæ­¥

- ä¸Šè¿°å¾ˆå¤šä¾‹å­éƒ½æœ‰å¼‚æ­¥ç‰ˆæœ¬ (å¼‚æ­¥ç”µæœºã€å¼‚æ­¥ç”µè·¯ã€å¼‚æ­¥çº¿ç¨‹)

=== å¹¶å‘ç¨‹åºä¸­çš„åŒæ­¥

å¹¶å‘ç¨‹åºçš„æ­¥è°ƒå¾ˆéš¾ä¿æŒ â€œå®Œå…¨ä¸€è‡´â€

- çº¿ç¨‹åŒæ­¥ï¼š *åœ¨æŸä¸ªæ—¶é—´ç‚¹å…±åŒè¾¾åˆ°äº’ç›¸å·²çŸ¥çš„çŠ¶æ€*

å†æ¬¡æŠŠçº¿ç¨‹æƒ³è±¡æˆæˆ‘ä»¬è‡ªå·±

- NPYï¼šç­‰æˆ‘æ´—ä¸ªå¤´å°±å‡ºé—¨/ç­‰æˆ‘æ‰“å®Œè¿™å±€æ¸¸æˆå°±æ¥
- èˆå‹ï¼šç­‰æˆ‘ä¿®å¥½è¿™ä¸ª bug å°±åƒé¥­
- å¯¼å¸ˆï¼šç­‰æˆ‘å‡ºå·®å›æ¥å°±è®¨è®ºè¿™ä¸ªè¯¾é¢˜
- jyy: ç­‰æˆ‘æˆä¸ºå·ç‹å°±èººå¹³
  - â€œå…ˆåˆ°å…ˆç­‰â€ï¼Œ *åœ¨æ¡ä»¶è¾¾æˆçš„ç¬é—´å†æ¬¡æ¢å¤å¹¶è¡Œ* 
  #tip("Tip")[
  çº¿ç¨‹çš„`join`, å°±æ˜¯ä¸€ä¸ªåŒæ­¥
  ]
  - åŒæ—¶å¼€å§‹å‡ºå»ç©/åƒé¥­/è®¨è®º

=== ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜ï¼šå­¦åºŸä½ å°±èµ¢äº†

99% çš„å®é™…å¹¶å‘é—®é¢˜éƒ½å¯ä»¥ç”¨ç”Ÿäº§è€…-æ¶ˆè´¹è€…è§£å†³ã€‚

```c
void Tproduce() { while (1) printf("("); }
void Tconsume() { while (1) printf(")"); }
```

åœ¨ `printf` å‰åå¢åŠ ä»£ç ï¼Œä½¿å¾—æ‰“å°çš„æ‹¬å·åºåˆ—æ»¡è¶³

- ä¸€å®šæ˜¯æŸä¸ªåˆæ³•æ‹¬å·åºåˆ—çš„å‰ç¼€
- æ‹¬å·åµŒå¥—çš„æ·±åº¦ä¸è¶…è¿‡ n
  - n=3, `((())())(((` åˆæ³•
  - n=3, `(((())))`, `(()))` ä¸åˆæ³• 
  #tip("Tip")[
  `push` > `pop`
  ]

ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜ä¸­çš„åŒæ­¥

- `Tproduce`: ç­‰åˆ°æœ‰ç©ºä½æ—¶æ‰èƒ½æ‰“å°å·¦æ‹¬å·
- `Tconsume`: ç­‰åˆ°æœ‰å¤šä½™çš„å·¦æ‹¬å·æ—¶æ‰èƒ½æ‰“å°å³æ‹¬å·

=== è®¡ç®—å›¾ã€è°ƒåº¦å™¨å’Œç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜

ä¸ºä»€ä¹ˆå« â€œç”Ÿäº§è€…-æ¶ˆè´¹è€…â€ è€Œä¸æ˜¯ â€œæ‹¬å·é—®é¢˜â€ï¼Ÿ

- "(": ç”Ÿäº§èµ„æº (ä»»åŠ¡)ã€æ”¾å…¥é˜Ÿåˆ—(push)
- ")": ä»é˜Ÿåˆ—å–å‡ºèµ„æº (ä»»åŠ¡) æ‰§è¡Œ(pop)

å¹¶è¡Œè®¡ç®—åŸºç¡€ï¼šè®¡ç®—å›¾

- è®¡ç®—ä»»åŠ¡æ„æˆæœ‰å‘æ— ç¯å›¾
  - $(u,v) \in E$è¡¨ç¤º u è¦ç”¨åˆ°å‰ v çš„å€¼
- åªè¦è°ƒåº¦å™¨ (ç”Ÿäº§è€…)
  åˆ†é…ä»»åŠ¡æ•ˆç‡å¤Ÿé«˜ï¼Œç®—æ³•å°±èƒ½å¹¶è¡Œ(æ‰§è¡Œä»»åŠ¡çš„æ—¶é—´è¿œè¿œæ¯”pushå’Œpopçš„æ—¶é—´é•¿)
  - ç”Ÿäº§è€…æŠŠä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—ä¸­
  - æ¶ˆè´¹è€… (workers) ä»é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡

#image("./images/computional graph.png")

#tip("Tip")[
- è¿˜æ˜¯éœ€è¦6æ­¥æ‰èƒ½ç®—å®Œã€‚ 
- æŠŠä»»ä½•ä¸€ä¸ªé—®é¢˜å¹¶è¡ŒåŒ–ï¼Œç”»å‡ºè®¡ç®—å›¾ã€‚ï¼ˆä¸‡èƒ½æ–¹æ³•ï¼‰
]

```
Tproduce
t1  (   )(join)
t2  ((   ))(join)
t3  (((   )))(join)
```
#tip("Tip")[
çº¿ç¨‹t2è¦åœ¨t1ç»“æŸåæ‰èƒ½æ‰§è¡Œã€‚æ‹“æ‰‘æ’åºã€‚
]

å®é™…ä¸Š,
å¦‚æœè®¡ç®—é‡å°çš„è¯åˆ’åˆ†å¯ä»¥æ›´çµæ´»ä¸€ç‚¹.ä¾‹å¦‚æŠŠå·¦ä¸Šè§’ä¸‰ä¸ªèŠ‚ç‚¹åˆ’åˆ†æˆä¸€ä¸ªã€‚å¦‚æœèŠ‚ç‚¹å¤ªå¤šï¼Œä¹Ÿå¯ä»¥åˆ†å¾—æ›´ç»†ä¸€äº›ã€‚

=== ç”Ÿäº§è€…-æ¶ˆè´¹è€…ï¼šå®ç°

èƒ½å¦ç”¨äº’æ–¥é”å®ç°æ‹¬å·é—®é¢˜ï¼Ÿ

- å·¦æ‹¬å·ï¼šåµŒå¥—æ·±åº¦ (é˜Ÿåˆ—) ä¸è¶³ n æ—¶æ‰èƒ½æ‰“å°
- å³æ‹¬å·ï¼šåµŒå¥—æ·±åº¦ (é˜Ÿåˆ—) > 1 æ—¶æ‰èƒ½æ‰“å°
  - å½“ç„¶æ˜¯ç­‰åˆ°æ»¡è¶³æ¡ä»¶æ—¶å†æ‰“å°äº† (ä»£ç æ¼”ç¤º) - ç”¨äº’æ–¥é”ä¿æŒæ¡ä»¶æˆç«‹

å¹¶å‘ï¼šå°å¿ƒï¼

- å‹åŠ›æµ‹è¯• + è§‚å¯Ÿè¾“å‡ºç»“æœ
- è‡ªåŠ¨è§‚å¯Ÿè¾“å‡ºç»“æœï¼š[ pc-check.py
  ](https://jyywiki.cn/pages/OS/2023/c/pc-check.py)
- æœªæ¥ï¼šcopilot è§‚å¯Ÿè¾“å‡ºç»“æœï¼Œå¹¶ç»™å‡ºä¿®å¤å»ºè®®
- æ›´è¿œçš„æœªæ¥ï¼šæˆ‘ä»¬éƒ½ä¸éœ€è¦ä¸å­˜åœ¨äº†

pc-mutex.c

```c
int n, count = 0;
mutex_t lk = MUTEX_INIT();

#define CAN_PRODUCE (count < n)
#define CAN_CONSUME (count > 0)

void Tproduce() {
    while (1) {
    retry:
        mutex_lock(&lk);
        if (!CAN_PRODUCE) {
            mutex_unlock(&lk);
            goto retry;
        } else {
            count++;
            printf("(");  // Push an element into buffer
            mutex_unlock(&lk);
        }
    }
}

void Tconsume() {
    while (1) {
    retry:
        mutex_lock(&lk);
        if (!CAN_CONSUME) {
            mutex_unlock(&lk);
            goto retry;
        } else {
            count--;
            printf(")");  // Pop an element from buffer
            mutex_unlock(&lk);
        }
    }
}

int main(int argc, char *argv[]) {
    assert(argc == 2);
    n = atoi(argv[1]);
    setbuf(stdout, NULL);
    for (int i = 0; i < 8; i++) {
        create(Tproduce);
        create(Tconsume);
    }
}
```

- `gcc -pthread pc-mutex.c`
  - `./a.out 1`
  - `./a.out 2`

å¦‚ä½•çŸ¥é“æ˜¯å¦æ­£ç¡®å‘¢ï¼Ÿ

== æ¡ä»¶å˜é‡

åˆšåˆšçš„å®ç°é‡Œé¢ä¾ç„¶æœ‰ä¸€ä¸ªspinçš„è¿‡ç¨‹ï¼Œæµªè´¹CPUèµ„æº 
#tip("Tip")[
è‡ªæ—‹é”çš„æ—¶å€™é¿å…æµªè´¹ï¼Œ å¾—ä¸åˆ°é”å°±æ”¾å¼ƒCPUã€‚
]

=== åŒæ­¥é—®é¢˜ï¼šåˆ†æ

#tip("Tip")[
çº¿ç¨‹åŒæ­¥ç”±æ¡ä»¶ä¸æˆç«‹ç­‰å¾…å’ŒåŒæ­¥æ¡ä»¶è¾¾æˆç»§ç»­æ„æˆ
]

çº¿ç¨‹ join

- Tmain åŒæ­¥æ¡ä»¶ï¼š`nexit == T`
- Tmain è¾¾æˆåŒæ­¥ï¼šæœ€åä¸€ä¸ªçº¿ç¨‹é€€å‡º `nexit++`

ç”Ÿäº§è€…/æ¶ˆè´¹è€…é—®é¢˜

- Tproduce åŒæ­¥æ¡ä»¶ï¼š`CAN_PRODUCE (count < n)`
- Tproduce è¾¾æˆåŒæ­¥ï¼š`Tconsume count--`
- Tconsume åŒæ­¥æ¡ä»¶ï¼š`CAN_CONSUME (count > 0)`
- Tconsume è¾¾æˆåŒæ­¥ï¼š`Tproduce count++`

=== ç†æƒ³ä¸­çš„åŒæ­¥ API

```c
wait_until(CAN_PRODUCE) {
  count++;
  printf("(");
}

wait_until(CAN_CONSUME) {
  count--;
  printf(")");
}
```

è‹¥å¹²å®ç°ä¸Šçš„éš¾é¢˜

- æ­£ç¡®æ€§
  - å¤§æ‹¬å·å†…ä»£ç æ‰§è¡Œæ—¶ï¼Œå…¶ä»–çº¿ç¨‹ä¸å¾—ç ´åç­‰å¾…çš„æ¡ä»¶
- æ€§èƒ½
  - ä¸èƒ½ spin check æ¡ä»¶è¾¾æˆ
  - å·²ç»åœ¨ç­‰å¾…çš„çº¿ç¨‹æ€ä¹ˆçŸ¥é“æ¡ä»¶è¢«æ»¡è¶³ï¼Ÿ

=== æ¡ä»¶å˜é‡ï¼šç†æƒ³ä¸å®ç°ä¹‹é—´çš„æŠ˜è¡·

ä¸€æŠŠäº’æ–¥é” + ä¸€ä¸ª â€œæ¡ä»¶å˜é‡â€ + æ‰‹å·¥å”¤é†’

- `wait(cv, mutex)` ğŸ’¤
  - è°ƒç”¨æ—¶å¿…é¡»ä¿è¯å·²ç»è·å¾— mutex
  - wait é‡Šæ”¾ mutexã€è¿›å…¥ç¡çœ çŠ¶æ€
  - è¢«å”¤é†’åéœ€è¦é‡æ–°æ‰§è¡Œ lock(mutex)
- `signal`/`notify(cv)` ğŸ’¬
  - éšæœºç§ä¿¡ä¸€ä¸ªç­‰å¾…è€…ï¼šé†’é†’
  - å¦‚æœæœ‰çº¿ç¨‹æ­£åœ¨ç­‰å¾… cvï¼Œåˆ™å”¤é†’å…¶ä¸­ä¸€ä¸ªçº¿ç¨‹
- `broadcast`/`notifyAll(cv)` ğŸ“£
  - å«é†’æ‰€æœ‰äºº
  - å”¤é†’å…¨éƒ¨æ­£åœ¨ç­‰å¾… cv çš„çº¿ç¨‹

==== æ¡ä»¶å˜é‡ï¼šå®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…

é”™è¯¯å®ç°ï¼š

```c
void Tproduce() {
  mutex_lock(&lk);
  if (!CAN_PRODUCE) cond_wait(&cv, &lk);
  printf("("); count++; cond_signal(&cv);
  mutex_unlock(&lk);
}

void Tconsume() {
  mutex_lock(&lk);
  if (!CAN_CONSUME) cond_wait(&cv, &lk);
  printf(")"); count--; cond_signal(&cv);
  mutex_unlock(&lk);
}
```

#tip("Tip")[
ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¸€å¤šå°±é”™äº†ã€‚
]

#image("./images/wrong-TC.png")

#tip("Tip")[
é”™è¯¯åŸå› ï¼Œ`if`æ¡ä»¶é‡Œï¼Œç­‰å¾…è¢«å”¤é†’çš„æ—¶å€™ifæ¡ä»¶æœªå¿…ä¾ç„¶æˆç«‹ã€‚æŠŠ`if`->`while`
]

ä»£ç æ¼”ç¤º & å‹åŠ›æµ‹è¯• & æ¨¡å‹æ£€éªŒ

(Small scope hypothesis)

==== æ¡ä»¶å˜é‡ï¼šæ­£ç¡®çš„æ‰“å¼€æ–¹å¼

åŒæ­¥çš„æœ¬è´¨ï¼š`wait_until(COND) { ... }`ï¼Œå› æ­¤ï¼š

éœ€è¦ç­‰å¾…æ¡ä»¶æ»¡è¶³æ—¶

```c
mutex_lock(&mutex);
while (!COND) { // 2
  wait(&cv, &mutex);    // 1
}
assert(cond);  // äº’æ–¥é”ä¿è¯æ¡ä»¶æˆç«‹ 3
mutex_unlock(&mutex);
```

ä»»ä½•æ”¹åŠ¨ä½¿å…¶ä»–çº¿å¯èƒ½è¢«æ»¡è¶³æ—¶

```c
mutex_lock(&mutex);
// ä»»ä½•å¯èƒ½ä½¿æ¡ä»¶æ»¡è¶³çš„ä»£ç 
broadcast(&cv);
mutex_unlock(&mutex);
```

ç»å¯¹ä¸ä¼šçŠ¯é”™ï¼šæ¡ä»¶ä¸æˆç«‹çš„æ—¶å€™whileç­‰å¾…ï¼Œæ¡ä»¶æˆç«‹çš„æ—¶å€™broadcast

== æ¡ä»¶å˜é‡ï¼šåº”ç”¨

=== æ¡ä»¶å˜é‡ï¼šä¸‡èƒ½å¹¶è¡Œè®¡ç®—æ¡†æ¶ (M2)

```c
struct work {
  void (*run)(void *arg);
  void *arg;
}

void Tworker() {
  while (1) {
    struct work *work;
    wait_until(has_new_work() || all_done) {
      work = get_work();
    }
    if (!work) break;
    else {
      work->run(work->arg); // å…è®¸ç”Ÿæˆæ–°çš„ work (æ³¨æ„äº’æ–¥)
      release(work);  // æ³¨æ„å›æ”¶ work åˆ†é…çš„èµ„æº
    }
  }
}
```

=== æ¡ä»¶å˜é‡ï¼šæ›´å¤æ€ªçš„ä¹ é¢˜/é¢è¯•é¢˜

æœ‰ä¸‰ç§çº¿ç¨‹

- Ta è‹¥å¹²: æ­»å¾ªç¯æ‰“å° <
- Tb è‹¥å¹²: æ­»å¾ªç¯æ‰“å° >
- Tc è‹¥å¹²: æ­»å¾ªç¯æ‰“å° \_

ä»»åŠ¡ï¼š

- å¯¹è¿™äº›çº¿ç¨‹è¿›è¡ŒåŒæ­¥ï¼Œä½¿å¾—å±å¹•æ‰“å°å‡º `<><_` å’Œ `><>_` çš„ç»„åˆ

è§£å†³åŒæ­¥é—®é¢˜ï¼Œ å›å½’æœ¬è´¨`wait_until (cond) with (mutex)`ä½¿ç”¨æ¡ä»¶å˜é‡ï¼Œåªè¦å›ç­”ä¸‰ä¸ªé—®é¢˜ï¼š

- æ‰“å° â€œ<â€ çš„æ¡ä»¶ï¼Ÿ
- æ‰“å° â€œ>â€ çš„æ¡ä»¶ï¼Ÿ
- æ‰“å° â€œ\_â€ çš„æ¡ä»¶ï¼Ÿ

çŠ¶æ€æœºã€‚
#image("./images/fish-SM.png")

```c
#define LENGTH(arr) (sizeof(arr) / sizeof(arr[0]))

enum {
    A = 1,
    B,
    C,
    D,
    E,
    F,
};

struct rule {
    int from, ch, to;
} rules[] = {
    {A, '<', B}, {B, '>', C}, {C, '<', D}, {A, '>', E},
    {E, '<', F}, {F, '>', D}, {D, '_', A},
};
int current = A, quota = 1;

mutex_t lk = MUTEX_INIT();
cond_t cv = COND_INIT();

int next(char ch) {
    for (int i = 0; i < LENGTH(rules); i++) {
        struct rule *rule = &rules[i];
        if (rule->from == current && rule->ch == ch) {
            return rule->to;
        }
    }
    return 0;
}

static int can_print(char ch) { return next(ch) != 0 && quota > 0; }

void fish_before(char ch) {
    mutex_lock(&lk);
    while (!can_print(ch)) {
        // can proceed only if (next(ch) && quota)
        cond_wait(&cv, &lk);
    }
    quota--;
    mutex_unlock(&lk);
}

void fish_after(char ch) {
    mutex_lock(&lk);
    quota++;
    current = next(ch);
    assert(current);
    cond_broadcast(&cv);
    mutex_unlock(&lk);
}

const char roles[] = ".<<<<<>>>>___";

void fish_thread(int id) {
    char role = roles[id];
    while (1) {
        fish_before(role);
        putchar(role);  // Not lock-protected
        fish_after(role);
    }
}

int main() {
    setbuf(stdout, NULL);
    for (int i = 0; i < strlen(roles); i++) create(fish_thread);
}
```

åªè¦å†™å‡º`can_print`å‡½æ•°ï¼Œå°±okã€‚

== æ€»ç»“

=== æŠŠä»»ä½•ç®—æ³•å¹¶è¡Œï¼šè®¡ç®—å›¾ã€‚

ä¸ç®¡ä»€ä¹ˆè®¡ç®—é—®é¢˜ï¼Œéƒ½æ˜¯ç”±xç®—å‡ºyï¼Œæ¥ç€ç”»å‡ºè®¡ç®—å›¾ã€‚

ä¾‹å¦‚å¤„ç†å™¨çš„ä¹±åºæ‰§è¡Œï¼Œ`x=0`,`y=2`,`t=x`.æŠŠæ¯ä¸ªæŒ‡ä»¤çœ‹æˆä¸€ä¸ªèŠ‚ç‚¹ã€‚tå’Œxå½¢æˆä¸€ä¸ªä¾èµ–å…³ç³»ï¼ŒRAWï¼ˆRead
After Writeï¼‰ï¼Œå»ºç«‹äº†ä¸€æ¡è¾¹ã€‚å…¶å®å°±æ˜¯æ‹“æ‰‘æ’åºï¼Œä½†æ˜¯ç”¨ç¡¬ä»¶ã€‚

=== å®ç°åŒæ­¥ï¼šç”Ÿäº§è€…æ¶ˆè´¹è€…

ä»»ä½•ä¸€ä¸ªçº¿ç¨‹æ€»è¦åšä¸€ä»¶äº‹ï¼Œä½†æ˜¯è¿™ä¸ªäº‹å„¿ä¸èƒ½éšä¾¿åšï¼Œè¦ç­‰æ¡ä»¶æ»¡è¶³çš„æ—¶å€™æ‰å¯ä»¥ã€‚æŠŠå¤šçº¿ç¨‹åŒæ­¥ï¼Œè¿™æ®µä»£ç æ‰§è¡Œçš„æ¡ä»¶æ˜¯ä»€ä¹ˆï¼Œç”¨ä¸‡èƒ½çš„äº’æ–¥é”ã€‚

å¹¶è¡Œä¸éƒ½ä¸¢æ‰äº†ï¼Ÿè®¡ç®—å›¾çš„æ—¶å€™ï¼ŒèŠ‚ç‚¹çš„æœ¬åœ°è®¡ç®—è¿œå¤§äºåŒæ­¥æˆ–è€…äº’æ–¥çš„å¼€é”€ã€‚
